<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Hyde &middot; A Jekyll theme
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Hyde
        </a>
      </h1>
      <p class="lead">A brazen two-column <a href="http://jekyllrb.com" target="_blank">Jekyll</a> theme that pairs a prominent sidebar with uncomplicated content. Made by <a href="https://twitter.com/mdo" target="_blank">@mdo</a>.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

      <a class="sidebar-nav-item" href="https://github.com/poole/hyde/archive/v2.1.0.zip">Download</a>
      <a class="sidebar-nav-item" href="https://github.com/poole/hyde">GitHub project</a>
      <span class="sidebar-nav-item">Currently v2.1.0</span>
    </nav>

    <p>&copy; 2018. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2018/02/14/Tree-Traversals-explained-They-re-like-a-class-of-lazy-students-trying-to-cheat-on-their-exam-b46563211427/">
        Tree Traversals explained: They‚Äôre like a class of lazy students trying to cheat on their exam
      </a>
    </h1>

    <span class="post-date">14 Feb 2018</span>
  
    
    <!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Tree Traversals explained: They‚Äôre like a class of lazy students trying to cheat on their exam</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 100%;
        margin: auto;
      }
      section {
        width: 100%;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 100%;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Tree Traversals explained: They‚Äôre like a class of lazy students trying to cheat on their exam</h1>
</header>
<section data-field="subtitle" class="p-summary">
Imagine that you are enrolled in a math class at one of the most prestigious universities of the world.
</section>
<section data-field="body" class="e-content">
<section name="83ec" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="5e0b" id="5e0b" class="graf graf--h3 graf--leading graf--title"></h3></div><div class="section-inner sectionLayout--fullWidth"><figure name="419e" id="419e" class="graf graf--figure graf--layoutFillWidth graf-after--h3"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.99999999999999%;"></div><img class="graf-image" data-image-id="1*tCYpJPPIECnHUWw9BR_vrg.png" data-width="1252" data-height="714" src="https://cdn-images-1.medium.com/max/2000/1*tCYpJPPIECnHUWw9BR_vrg.png"></div><figcaption class="imageCaption"><a href="http://blog.noplag.com/wp-content/uploads/2017/01/cheating-on-a-test-clip-art-red-cheating-on-blues-test.png" data-href="http://blog.noplag.com/wp-content/uploads/2017/01/cheating-on-a-test-clip-art-red-cheating-on-blues-test.png" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">http://blog.noplag.com/wp-content/uploads/2017/01/cheating-on-a-test-clip-art-red-cheating-on-blues-test.png</a></figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="3d47" id="3d47" class="graf graf--p graf-after--figure">Imagine that you are enrolled in a math class at one of the most prestigious universities of the world.
    <br>
    <a href="/2018/02/14/Tree-Traversals-explained-They-re-like-a-class-of-lazy-students-trying-to-cheat-on-their-exam-b46563211427/">
         Read More...
    </a>
    <hr>
    <!--<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Tree Traversals explained: They‚Äôre like a class of lazy students trying to cheat on their exam</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 100%;
        margin: auto;
      }
      section {
        width: 100%;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 100%;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Tree Traversals explained: They‚Äôre like a class of lazy students trying to cheat on their exam</h1>
</header>
<section data-field="subtitle" class="p-summary">
Imagine that you are enrolled in a math class at one of the most prestigious universities of the world.
</section>
<section data-field="body" class="e-content">
<section name="83ec" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="5e0b" id="5e0b" class="graf graf--h3 graf--leading graf--title"></h3></div><div class="section-inner sectionLayout--fullWidth"><figure name="419e" id="419e" class="graf graf--figure graf--layoutFillWidth graf-after--h3"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.99999999999999%;"></div><img class="graf-image" data-image-id="1*tCYpJPPIECnHUWw9BR_vrg.png" data-width="1252" data-height="714" src="https://cdn-images-1.medium.com/max/2000/1*tCYpJPPIECnHUWw9BR_vrg.png"></div><figcaption class="imageCaption"><a href="http://blog.noplag.com/wp-content/uploads/2017/01/cheating-on-a-test-clip-art-red-cheating-on-blues-test.png" data-href="http://blog.noplag.com/wp-content/uploads/2017/01/cheating-on-a-test-clip-art-red-cheating-on-blues-test.png" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">http://blog.noplag.com/wp-content/uploads/2017/01/cheating-on-a-test-clip-art-red-cheating-on-blues-test.png</a></figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="3d47" id="3d47" class="graf graf--p graf-after--figure">Imagine that you are enrolled in a math class at one of the most prestigious universities of the world.  <p name="0f00" id="0f00" class="graf graf--p graf-after--p">You have an exam coming up real soon. Obviously, you want to perform well on the exam.-->
    <!--<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Tree Traversals explained: They‚Äôre like a class of lazy students trying to cheat on their exam</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 100%;
        margin: auto;
      }
      section {
        width: 100%;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 100%;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Tree Traversals explained: They‚Äôre like a class of lazy students trying to cheat on their exam</h1>
</header>
<section data-field="subtitle" class="p-summary">
Imagine that you are enrolled in a math class at one of the most prestigious universities of the world.
</section>
<section data-field="body" class="e-content">
<section name="83ec" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="5e0b" id="5e0b" class="graf graf--h3 graf--leading graf--title"></h3></div><div class="section-inner sectionLayout--fullWidth"><figure name="419e" id="419e" class="graf graf--figure graf--layoutFillWidth graf-after--h3"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.99999999999999%;"></div><img class="graf-image" data-image-id="1*tCYpJPPIECnHUWw9BR_vrg.png" data-width="1252" data-height="714" src="https://cdn-images-1.medium.com/max/2000/1*tCYpJPPIECnHUWw9BR_vrg.png"></div><figcaption class="imageCaption"><a href="http://blog.noplag.com/wp-content/uploads/2017/01/cheating-on-a-test-clip-art-red-cheating-on-blues-test.png" data-href="http://blog.noplag.com/wp-content/uploads/2017/01/cheating-on-a-test-clip-art-red-cheating-on-blues-test.png" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">http://blog.noplag.com/wp-content/uploads/2017/01/cheating-on-a-test-clip-art-red-cheating-on-blues-test.png</a></figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="3d47" id="3d47" class="graf graf--p graf-after--figure">Imagine that you are enrolled in a math class at one of the most prestigious universities of the world.</p><p name="0f00" id="0f00" class="graf graf--p graf-after--p">You have an exam coming up real soon. Obviously, you want to perform well on the exam.</p><p name="2159" id="2159" class="graf graf--p graf-after--p">The thing about this university is that it has a clumsy set of professors. So cheating is really simple. You can easily copy from the guy sitting behind and ahead without getting caught.</p><p name="921b" id="921b" class="graf graf--p graf-after--p">The professors, in order to take control of this problem, came up with two solutions:</p><ul class="postList"><li name="3554" id="3554" class="graf graf--li graf-after--p">The number of students sitting in a class is never fixed. And the people sitting in one class taking the test change from one test to another.</li><li name="313f" id="313f" class="graf graf--li graf-after--li">The seating arrangement is released five minutes before the exam. The seating arrangement is alphabetical. But since the students are never fixed and new ones may get added or old ones removed from a class randomly, the arrangement has to be explicitly released for the students to know where exactly they have to sit.</li></ul><p name="77f7" id="77f7" class="graf graf--p graf-after--li">Say you‚Äôre one of those lazy students who wants to cheat, despite the consequences. Five minutes before the exam when the seating arrangement is released, how do you find out who is sitting in front of you and who‚Äôs behind as quickly as possible?</p><p name="c776" id="c776" class="graf graf--p graf-after--p">You won‚Äôt be able to cheat if you don‚Äôt talk to these two people beforehand and strategize, right?</p><h3 name="ed83" id="ed83" class="graf graf--h3 graf-after--p">The Seating Arrangement</h3><p name="458f" id="458f" class="graf graf--p graf-after--h3">So the professors released the seating arrangement for the first test ever conducted this way. Say it had N students. If these students were to remain the same from one test to another, then it would have been very easy to cheat, right? Because the seating arrangement is always done alphabetically.</p><p name="3d37" id="3d37" class="graf graf--p graf-after--p">Therefore, the professors keep on adding or removing students from this list from one test to another, and only released these modifications before each test. This way, students could never know deterministically before a test who would be sitting in front of or behind them.</p><p name="8d25" id="8d25" class="graf graf--p graf-after--p">Let‚Äôs consider this problem in algorithmic terms. We are given a list of N elements where elements in this case are student‚Äôs names. This list keeps on varying from one exam to another, such that new elements can be added to the list or existing elements can be removed from the list.</p><p name="0d17" id="0d17" class="graf graf--p graf-after--p">Given the list of modifications at any given time T and a name N, we need to determine the elements B and A, such that B would come right before N and A would come right after N if the list were to be sorted.</p><p name="173b" id="173b" class="graf graf--p graf-after--p">Now let‚Äôs look at what data structures are available to us and what would suit this problem the best.</p><h3 name="c56c" id="c56c" class="graf graf--h3 graf-after--p">Oh Array, my old friend, will you help¬†me?</h3><p name="be20" id="be20" class="graf graf--p graf-after--h3">Using an array seems to be a rather straightforward approach.</p><ul class="postList"><li name="4486" id="4486" class="graf graf--li graf-after--p">We can simply put all the names on the released list in an array.</li><li name="1265" id="1265" class="graf graf--li graf-after--li">Then we sort all the names (the list of names released might be randomly arranged) lexicographically</li><li name="c626" id="c626" class="graf graf--li graf-after--li">And then we can find our name in the list by using a binary search procedure. This would give us the predecessor and the successor.</li></ul><p name="fab0" id="fab0" class="graf graf--p graf-after--li">This seems to be a viable approach to solve this problem. The issue at hand, however, is that the students are never fixed from one exam to another. And so the list that was released for the very first exam would vary dynamically when new students were added and old ones were removed.</p><p name="a57e" id="a57e" class="graf graf--p graf-after--p">We can sort the list for the very first time, and then keep on adding new elements and removing old ones accordingly moving forward.</p><p name="23fa" id="23fa" class="graf graf--p graf-after--p">However, the complexity of adding or removing an element from an array is of the order <code class="markup--code markup--p-code">O(n)</code>¬†. Since the number of students could be very large, and we don‚Äôt know how many modifications there would be before some new test, this would take a lot of time and the test would start before we could solve the problem. Remember that the modifications are released just five minutes before the test.</p><p name="d1e6" id="d1e6" class="graf graf--p graf-after--p">So what other data structure do we have where insertion and deletion can be done very quickly?</p><h3 name="334b" id="334b" class="graf graf--h3 graf-after--p">Hmmmm, maybe Linked List is my true friend after¬†all</h3><p name="77b0" id="77b0" class="graf graf--p graf-after--h3">As far as a linked list is concerned, it has it‚Äôs own set of problems when dealing with this type of situation. Initially, we need to sort the list of elements lexicographically. Since this is a one-time operation, because it is only to be done for the first exam, the time taken here does not really matter.</p><p name="310c" id="310c" class="graf graf--p graf-after--p">From the next exam onwards, only the modifications are released. Adding or deleting an element from a linked list is a constant time operation, provided we know the location of that element in the list.</p><p name="378e" id="378e" class="graf graf--p graf-after--p">Finding an element in a linked list is a linear time operation‚Ää‚Äî‚Ääit takes <code class="markup--code markup--p-code">O(n)</code>¬†. I know there are concepts like <a href="https://en.wikipedia.org/wiki/Skip_list" data-href="https://en.wikipedia.org/wiki/Skip_list" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">skip lists</a>, but why dive into something like this when we can solve this problem in a much better fashion by using another type of data structure?</p><h3 name="12d4" id="12d4" class="graf graf--h3 graf-after--p">Enter Binary Search Trees, the new kid in¬†town</h3><p name="a1f7" id="a1f7" class="graf graf--p graf-after--h3">Let‚Äôs look at how we can model our data using a binary search tree (BST). Then we‚Äôll see how a BST can help us solve the problem we initially set out to solve.</p><p name="bc4e" id="bc4e" class="graf graf--p graf-after--p">A Binary Search Tree is basically a binary tree with a special way of ordering the nodes.</p><p name="0e66" id="0e66" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">For a node with key <em class="markup--em markup--p-em">k</em>, every key in the left subtree is less than <em class="markup--em markup--p-em">k </em>and every key in the right subtree is greater than <em class="markup--em markup--p-em">k</em>.</strong></p><p name="9e6b" id="9e6b" class="graf graf--p graf-after--p">In our case, the keys will be the names of the students.</p><p name="fc77" id="fc77" class="graf graf--p graf-after--p">Consider the following example to see how a binary search tree is constructed. This should lend greater clarity to the data structure.</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="2272" id="2272" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1000px; max-height: 1167px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 116.7%;"></div><img class="graf-image" data-image-id="1*fvAa2lIvPcl3pEF0EwjT_g.png" data-width="1200" data-height="1400" src="https://cdn-images-1.medium.com/max/1000/1*fvAa2lIvPcl3pEF0EwjT_g.png"></div><figcaption class="imageCaption"><a href="http://btechsmartclass.com/DS/images/BST%20Construction.png" data-href="http://btechsmartclass.com/DS/images/BST%20Construction.png" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">http://btechsmartclass.com/DS/images/BST%20Construction.png</a></figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="7c4f" id="7c4f" class="graf graf--p graf-after--figure">Constructing a Binary Search Tree is not enough. We need to make sure it is <a href="http://www.stoimen.com/blog/2012/07/03/computer-algorithms-balancing-a-binary-search-tree/" data-href="http://www.stoimen.com/blog/2012/07/03/computer-algorithms-balancing-a-binary-search-tree/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">balanced</a>. The reason we say that a Binary Search Tree needs to be balanced is that, if it is not balanced, then we can have something like this:</p><figure name="c4e4" id="c4e4" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 781px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 111.60000000000001%;"></div><img class="graf-image" data-image-id="1*4rHcryjV-ySjXORcxzqQeA.png" data-width="896" data-height="1000" src="https://cdn-images-1.medium.com/max/800/1*4rHcryjV-ySjXORcxzqQeA.png"></div><figcaption class="imageCaption">A left skewed binary search¬†tree.</figcaption></figure><p name="5523" id="5523" class="graf graf--p graf-after--figure">This is known as a skewed binary search tree. If such a thing happens, then the BST basically transforms into a linked list and that is of no use to us. Therefore, we have this notion of keeping a BST balanced so that we don‚Äôt run into this problem.</p><p name="f2ea" id="f2ea" class="graf graf--p graf-after--p">The notion of balanced is defined differently by different approaches, like Red Black Trees or AVL trees. Further explanation of these trees is out of the scope of this article.</p><p name="8aba" id="8aba" class="graf graf--p graf-after--p">Coming back to arranging our data in a balanced BST: the keys to our BST would be the names of the students, and lexicographic matching would be used to determine the structure of the BST.</p><p name="edc4" id="edc4" class="graf graf--p graf-after--p">Suppose that there were a million students taking the test. If our binary search tree is balanced, then the complexity of performing any operation is upper bounded by <code class="markup--code markup--p-code">O(log(n))</code>¬†. <strong class="markup--strong markup--p-strong">Hence, for 1 million nodes, the maximum number of nodes to be scanned would be just 14.</strong></p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="bcfe" id="bcfe" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1000px; max-height: 750px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 75%;"></div><img class="graf-image" data-image-id="1*WX_no1yjkuvyro78viF21w.png" data-width="1920" data-height="1440" src="https://cdn-images-1.medium.com/max/1000/1*WX_no1yjkuvyro78viF21w.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="57ea" id="57ea" class="graf graf--p graf-after--figure">That‚Äôs a lot of complexity reduction simply by arranging the data in a certain manner. That is the advantage of representing data in a <strong class="markup--strong markup--p-strong">balanced<em class="markup--em markup--p-em"> </em></strong>Binary Search Tree.</p><p name="4acf" id="4acf" class="graf graf--p graf-after--p">The main problem with the array-based approach was that we could not efficiently insert or delete an element from the array. And the problem with the linked list approach was that there was no efficient way for us to find an element in the linked list even if it were sorted.</p><p name="53ff" id="53ff" class="graf graf--p graf-after--p">As for a balanced binary search tree, the time complexity to insert, delete, or search for an element is all bounded by <code class="markup--code markup--p-code">O(log(n))</code>¬†. And this is precisely what makes this data structure extremely exciting.</p><p name="d72e" id="d72e" class="graf graf--p graf-after--p">However, we still haven‚Äôt solved our original problem. Given the name of a student, we want to find out the student sitting right behind and right in front of them. This boils down to finding the <strong class="markup--strong markup--p-strong">in-order successor and predecessor in the given Binary Search Tree.</strong></p><h3 name="f5a0" id="f5a0" class="graf graf--h3 graf-after--p">In-order Traversal and Sorted Order in a¬†BST</h3><p name="cc30" id="cc30" class="graf graf--p graf-after--h3">An interesting property of the binary search trees is that we can retrieve the elements in the sorted order (even reverse) by doing an in-order traversal over the binary search tree.</p><p name="5169" id="5169" class="graf graf--p graf-after--p">So the in-order successor of a node X is the element that comes right after X in the in-order traversal over the given BST. For our cheating problem, this in-order successor would be the student sitting in front of us.</p><p name="ed62" id="ed62" class="graf graf--p graf-after--p">The in-order predecessor of a node X is the element that comes right before X in the in-order traversal (or the element that comes right after X in the <strong class="markup--strong markup--p-strong">reverse<em class="markup--em markup--p-em"> </em></strong>in-order traversal) over the given BST. For our cheating problem, this in-order predecessor would be the student sitting right behind us.</p><h3 name="6134" id="6134" class="graf graf--h3 graf-after--p">In-order Successor in a¬†BST</h3><p name="33f2" id="33f2" class="graf graf--p graf-after--h3">There are two different cases that we need to handle when finding the in-order successor of a node in a BST.</p><p name="245d" id="245d" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">The first case</strong> is when the right child exists for the node whose in-order successor we are trying to find. Consider the following example.</p><figure name="6e30" id="6e30" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 657px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 93.8%;"></div><img class="graf-image" data-image-id="1*HT_4eHf-yWORRyajZGfbqg.png" data-width="1164" data-height="1092" src="https://cdn-images-1.medium.com/max/800/1*HT_4eHf-yWORRyajZGfbqg.png"></div></figure><p name="2b63" id="2b63" class="graf graf--p graf-after--figure">Here we wanted to find the in-order successor of the highlighted node 8. Since it has a right child, the <strong class="markup--strong markup--p-strong">in-order successor would be the leftmost node in the tree with a right child, or 15 as the root</strong>. So that node would be 10 in this case.</p><p name="d2ca" id="d2ca" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">The second case</strong> is when there is no right child.</p><figure name="8cae" id="8cae" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 491px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 70.1%;"></div><img class="graf-image" data-image-id="1*z6Q879IxNa5B6jRC6s1CaQ.png" data-width="1024" data-height="718" src="https://cdn-images-1.medium.com/max/800/1*z6Q879IxNa5B6jRC6s1CaQ.png"></div></figure><p name="5c99" id="5c99" class="graf graf--p graf-after--figure">In this case, the in-order successor has two possibilities:</p><ol class="postList"><li name="0bac" id="0bac" class="graf graf--li graf-after--p">One is where the node under consideration is the left child of its parent. In this case, the in-order successor would be the parent itself. So for our given case, the in-order successor would be 10.</li><li name="d6a3" id="d6a3" class="graf graf--li graf-after--li">The second case is when the current node is the right child of it‚Äôs parent. And it doesn‚Äôt have a right child. So it is the rightmost node in the BST and it has no in-order successor.</li></ol><p name="45f3" id="45f3" class="graf graf--p graf-after--li">Handling the first case is fairly simple for a binary search tree. For the second case, where the given node does not have a right child (or any parent pointers), we will have to rely on our good ol‚Äô recursion mechanism and do an in-order traversal until we figure out the parent of our given node.</p><figure name="b0af" id="b0af" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/edorado93/3027aa03ef813ae30d318d1b5e4de6bc.js"></script></figure><p name="e5e6" id="e5e6" class="graf graf--p graf-after--figure">So, the worst case complexity can be O(n) if the case above occurs.</p><p name="9030" id="9030" class="graf graf--p graf-after--p">Using this algorithm, we can quickly find out the student who will be sitting right in front of us in the exam.</p><h3 name="f498" id="f498" class="graf graf--h3 graf-after--p">In-order Predecessor in a¬†BST</h3><p name="a6fe" id="a6fe" class="graf graf--p graf-after--h3">This is the exact reverse of the previous case.</p><p name="1298" id="1298" class="graf graf--p graf-after--p">Again, we need to handle two different cases when finding the in-order predecessor of a node in a BST. Look at the following diagrams and try to relate the two cases being referred to here.</p><figure name="cfc2" id="cfc2" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 585px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 83.6%;"></div><img class="graf-image" data-image-id="1*8LEzigzWixE_psr5BDeqdA.png" data-width="1100" data-height="920" src="https://cdn-images-1.medium.com/max/800/1*8LEzigzWixE_psr5BDeqdA.png"></div></figure><p name="9a68" id="9a68" class="graf graf--p graf-after--figure">This is the case where the node has a left child. We need to find the rightmost child of the tree rooted at this left child‚Ää‚Äî‚Ääthe rightmost node in the tree rooted at 2.</p><figure name="a3da" id="a3da" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 556px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 79.4%;"></div><img class="graf-image" data-image-id="1*MXJ1lCqihi0bmcfelm5WFA.png" data-width="1096" data-height="870" src="https://cdn-images-1.medium.com/max/800/1*MXJ1lCqihi0bmcfelm5WFA.png"></div></figure><p name="1e87" id="1e87" class="graf graf--p graf-after--figure">No left child. So we need to find the parent.</p><figure name="3c9b" id="3c9b" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/edorado93/ada4adda364c26e87ff658659eb082b2.js"></script></figure><p name="4ae6" id="4ae6" class="graf graf--p graf-after--figure">If you look closely, I‚Äôve just reversed the order of traversal here and the rest of the code is the same as before. (NOTE: this code is used when there is no left child of the node for which we want to find the in-order predecessor).</p><p name="b363" id="b363" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">In-order predecessor becomes the reverse in-order successor.</strong></p><p name="b36d" id="b36d" class="graf graf--p graf-after--p">Well now that you know how you should arrange the class seating arrangement list, go get some solid marks üòúüòúüòú. Just kidding!! Cheating is bad‚Ää‚Äî‚Äädon‚Äôt ever do it!</p><p name="4fa9" id="4fa9" class="graf graf--p graf-after--p">Hope you got the main idea behind the different usages for data structures and how to find the in-order successor and predecessor in a BST.</p><p name="502e" id="502e" class="graf graf--p graf-after--p graf--trailing">EDIT: Kudos to <a href="https://medium.com/u/842b783318b8" data-href="https://medium.com/u/842b783318b8" data-anchor-type="2" data-user-id="842b783318b8" data-action-value="842b783318b8" data-action="show-user-card" data-action-type="hover" class="markup--user markup--p-user" target="_blank">Divya Godayal</a> for pointing out a set of major mistakes in the initial draft and also for ensuring that the article flows nicely¬†:)¬†:)</p></div></div></section>
</section>
</article></body></html>-->
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/12/20/Let-s-Backtrack-And-Save-Some-Queens-1f9ef6af5415/">
        Let‚Äôs Backtrack And Save Some Queens
      </a>
    </h1>

    <span class="post-date">20 Dec 2017</span>
  
    
    <!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Let‚Äôs Backtrack And Save Some Queens</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 100%;
        margin: auto;
      }
      section {
        width: 100%;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 100%;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Let‚Äôs Backtrack And Save Some Queens</h1>
</header>
<section data-field="subtitle" class="p-summary">
That‚Äôs a weird looking title, that probably doesn‚Äôt make sense right now. But trust me, this is a pretty long post and is really fun!
</section>
<section data-field="body" class="e-content">
<section name="ed44" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="c283" id="c283" class="graf graf--h3 graf--leading graf--title"></h3></div><div class="section-inner sectionLayout--outsetColumn"><figure name="5d03" id="5d03" class="graf graf--figure graf--layoutOutsetCenter graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1000px; max-height: 750px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 75%;"></div><img class="graf-image" data-image-id="1*uHVAfKRI6gPxiAmzCTnRCg.jpeg" data-width="1200" data-height="900" data-is-featured="true" src="https://cdn-images-1.medium.com/max/1000/1*uHVAfKRI6gPxiAmzCTnRCg.jpeg"></div><figcaption class="imageCaption"><a href="https://derickbailey.com/wp-content/uploads/2015/01/recursion1.jpg" data-href="https://derickbailey.com/wp-content/uploads/2015/01/recursion1.jpg" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">https://derickbailey.com/wp-content/uploads/2015/01/recursion1.jpg</a></figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="88b9" id="88b9" class="graf graf--p graf-after--figure">That‚Äôs a weird looking title, that probably doesn‚Äôt make sense right now. But trust me, this is a pretty long post and is really fun!
    <br>
    <a href="/2017/12/20/Let-s-Backtrack-And-Save-Some-Queens-1f9ef6af5415/">
         Read More...
    </a>
    <hr>
    <!--<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Let‚Äôs Backtrack And Save Some Queens</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 100%;
        margin: auto;
      }
      section {
        width: 100%;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 100%;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Let‚Äôs Backtrack And Save Some Queens</h1>
</header>
<section data-field="subtitle" class="p-summary">
That‚Äôs a weird looking title, that probably doesn‚Äôt make sense right now. But trust me, this is a pretty long post and is really fun!
</section>
<section data-field="body" class="e-content">
<section name="ed44" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="c283" id="c283" class="graf graf--h3 graf--leading graf--title"></h3></div><div class="section-inner sectionLayout--outsetColumn"><figure name="5d03" id="5d03" class="graf graf--figure graf--layoutOutsetCenter graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1000px; max-height: 750px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 75%;"></div><img class="graf-image" data-image-id="1*uHVAfKRI6gPxiAmzCTnRCg.jpeg" data-width="1200" data-height="900" data-is-featured="true" src="https://cdn-images-1.medium.com/max/1000/1*uHVAfKRI6gPxiAmzCTnRCg.jpeg"></div><figcaption class="imageCaption"><a href="https://derickbailey.com/wp-content/uploads/2015/01/recursion1.jpg" data-href="https://derickbailey.com/wp-content/uploads/2015/01/recursion1.jpg" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">https://derickbailey.com/wp-content/uploads/2015/01/recursion1.jpg</a></figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="88b9" id="88b9" class="graf graf--p graf-after--figure">That‚Äôs a weird looking title, that probably doesn‚Äôt make sense right now. But trust me, this is a pretty long post and is really fun!  <h4 name="db6f" id="db6f" class="graf graf--h4 graf-after--p">What is Backtracking¬†?</h4><p name="ef53" id="ef53" class="graf graf--p graf-after--h4"><a href="https://en.wikipedia.org/wiki/Backtracking" data-href="https://en.wikipedia.org/wiki/Backtracking" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Backtracking</a> is a standard problem solving technique based on <a href="https://medium.freecodecamp.org/recursion-recursion-recursion-4db8890a674d" data-href="https://medium.freecodecamp.org/recursion-recursion-recursion-4db8890a674d" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">recursion</a>.-->
    <!--<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Let‚Äôs Backtrack And Save Some Queens</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 100%;
        margin: auto;
      }
      section {
        width: 100%;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 100%;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Let‚Äôs Backtrack And Save Some Queens</h1>
</header>
<section data-field="subtitle" class="p-summary">
That‚Äôs a weird looking title, that probably doesn‚Äôt make sense right now. But trust me, this is a pretty long post and is really fun!
</section>
<section data-field="body" class="e-content">
<section name="ed44" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="c283" id="c283" class="graf graf--h3 graf--leading graf--title"></h3></div><div class="section-inner sectionLayout--outsetColumn"><figure name="5d03" id="5d03" class="graf graf--figure graf--layoutOutsetCenter graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1000px; max-height: 750px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 75%;"></div><img class="graf-image" data-image-id="1*uHVAfKRI6gPxiAmzCTnRCg.jpeg" data-width="1200" data-height="900" data-is-featured="true" src="https://cdn-images-1.medium.com/max/1000/1*uHVAfKRI6gPxiAmzCTnRCg.jpeg"></div><figcaption class="imageCaption"><a href="https://derickbailey.com/wp-content/uploads/2015/01/recursion1.jpg" data-href="https://derickbailey.com/wp-content/uploads/2015/01/recursion1.jpg" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">https://derickbailey.com/wp-content/uploads/2015/01/recursion1.jpg</a></figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="88b9" id="88b9" class="graf graf--p graf-after--figure">That‚Äôs a weird looking title, that probably doesn‚Äôt make sense right now. But trust me, this is a pretty long post and is really fun!</p><h4 name="db6f" id="db6f" class="graf graf--h4 graf-after--p">What is Backtracking¬†?</h4><p name="ef53" id="ef53" class="graf graf--p graf-after--h4"><a href="https://en.wikipedia.org/wiki/Backtracking" data-href="https://en.wikipedia.org/wiki/Backtracking" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Backtracking</a> is a standard problem solving technique based on <a href="https://medium.freecodecamp.org/recursion-recursion-recursion-4db8890a674d" data-href="https://medium.freecodecamp.org/recursion-recursion-recursion-4db8890a674d" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">recursion</a>.</p><p name="102a" id="102a" class="graf graf--p graf-after--p">A backtracking algorithm tries to build a solution to a computational problem incrementally. Whenever the algorithm needs to decide between multiple alternatives to the next component of the solution, it simply tries all possible options recursively.</p><p name="500c" id="500c" class="graf graf--p graf-after--p"><a href="https://en.wikipedia.org/wiki/Depth-first_search" data-href="https://en.wikipedia.org/wiki/Depth-first_search" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Depth First Search</a> (DFS) uses the concept of backtracking at its very core. So, in DFS, we basically try exploring all the paths from the given node recursively until we reach the goal. After we explore a particular branch of a tree in DFS, we can land up in two possible states.</p><ul class="postList"><li name="ee9b" id="ee9b" class="graf graf--li graf-after--p">We found the goal state in which case we simply exit.</li><li name="ad94" id="ad94" class="graf graf--li graf-after--li">Or, we did not find the goal state and we hit a dead end. In this scenario, we <strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">backtrack to the last checkpoint </em></strong>and we then try out a different branch.</li></ul><p name="51bc" id="51bc" class="graf graf--p graf-after--li">For detailed introduction to the Depth First Search Algorithm, go through</p><div name="1a77" id="1a77" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/basecs/deep-dive-through-a-graph-dfs-traversal-8177df5d0f13" data-href="https://medium.com/basecs/deep-dive-through-a-graph-dfs-traversal-8177df5d0f13" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/basecs/deep-dive-through-a-graph-dfs-traversal-8177df5d0f13"><strong class="markup--strong markup--mixtapeEmbed-strong">Deep Dive Through A Graph: DFS Traversal</strong><br><em class="markup--em markup--mixtapeEmbed-em">For better or for worse, there‚Äôs always more than one way to do something. Luckily for us, in the world of software and‚Ä¶</em>medium.com</a><a href="https://medium.com/basecs/deep-dive-through-a-graph-dfs-traversal-8177df5d0f13" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="bb894314fd4f6106b914ca6c727c3402" data-thumbnail-img-id="1*gb8XfmH7x8fJniMeXk4uHg.jpeg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*gb8XfmH7x8fJniMeXk4uHg.jpeg);"></a></div><p name="da54" id="da54" class="graf graf--p graf-after--mixtapeEmbed">and for a detailed intro to backtracking and recursion in general, check out the following two articles.</p><div name="5c3d" id="5c3d" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/@andreaiacono/backtracking-explained-7450d6ef9e1a" data-href="https://medium.com/@andreaiacono/backtracking-explained-7450d6ef9e1a" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/@andreaiacono/backtracking-explained-7450d6ef9e1a"><strong class="markup--strong markup--mixtapeEmbed-strong">Backtracking explained</strong><br><em class="markup--em markup--mixtapeEmbed-em">Backtracking is one of my favourite algorithms because of its simplicity and elegance; it doesn‚Äôt always have great‚Ä¶</em>medium.com</a><a href="https://medium.com/@andreaiacono/backtracking-explained-7450d6ef9e1a" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="5e0934b7f97faaa007e516c4fd5af65f" data-thumbnail-img-id="1*UOupQbgJEDuOTgZSLg-EfQ.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*UOupQbgJEDuOTgZSLg-EfQ.png);"></a></div><div name="cc4b" id="cc4b" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://medium.freecodecamp.org/how-recursion-works-explained-with-flowcharts-and-a-video-de61f40cb7f9" data-href="https://medium.freecodecamp.org/how-recursion-works-explained-with-flowcharts-and-a-video-de61f40cb7f9" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.freecodecamp.org/how-recursion-works-explained-with-flowcharts-and-a-video-de61f40cb7f9"><strong class="markup--strong markup--mixtapeEmbed-strong">How Recursion Works‚Ää‚Äî‚Ääexplained with flowcharts and a video</strong><br><em class="markup--em markup--mixtapeEmbed-em">‚ÄúIn order to understand recursion, one must first understand recursion.‚Äù</em>medium.freecodecamp.org</a><a href="https://medium.freecodecamp.org/how-recursion-works-explained-with-flowcharts-and-a-video-de61f40cb7f9" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="b6725f4a6fbfe17fe20e9e11c9c2acab" data-thumbnail-img-id="1*FVSUmSQEEsagXaKa_ajtvA.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*FVSUmSQEEsagXaKa_ajtvA.png);"></a></div><p name="77cf" id="77cf" class="graf graf--p graf-after--mixtapeEmbed">Now that we are all pros in backtracking and recursion, let‚Äôs see what do ‚ÄúQueens‚Äù have to do with all this.</p><h3 name="447c" id="447c" class="graf graf--h3 graf-after--p">The Famous N-Queens¬†Problem</h3><p name="82ff" id="82ff" class="graf graf--p graf-after--h3"><a href="http://www.drdobbs.com/jvm/optimal-queens/184406068" data-href="http://www.drdobbs.com/jvm/optimal-queens/184406068" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Positioning queens</a> on a chess board is a classical problem in mathematics and computer science.</p><p name="fe79" id="fe79" class="graf graf--p graf-after--p">The <a href="https://en.wikipedia.org/wiki/Eight_queens_puzzle" data-href="https://en.wikipedia.org/wiki/Eight_queens_puzzle" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Queen‚Äôs Puzzle</a> (aka the eight queens puzzle), was originally published in 1848. It involves placing eight queens on an 8x8 chess board, in such a manner that no two queens can attack each other.</p><p name="c133" id="c133" class="graf graf--p graf-after--p">The queen happens to be the most powerful piece on the chess board, primarily because of the freedom of movement that it has.</p><p name="393f" id="393f" class="graf graf--p graf-after--p">The queen can move in 8 different directions, as illustrated in the image below:</p><figure name="4b47" id="4b47" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 417px; max-height: 397px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 95.19999999999999%;"></div><img class="graf-image" data-image-id="1*t_J-RtgpiipfiXhHs8uywg.jpeg" data-width="417" data-height="397" src="https://cdn-images-1.medium.com/max/800/1*t_J-RtgpiipfiXhHs8uywg.jpeg"></div><figcaption class="imageCaption">8 directions for the Queen‚Äôs movement.</figcaption></figure><p name="a89c" id="a89c" class="graf graf--p graf-after--figure">This freedom of movement is what makes the N-queens problem extremely hard.</p><p name="8d4e" id="8d4e" class="graf graf--p graf-after--p">Below is a short overview of how the remainder of this article progresses. We‚Äôll discuss 4 different algorithms to solve the problem:</p><ul class="postList"><li name="ad0f" id="ad0f" class="graf graf--li graf-after--p">The Brute Force solution.</li><li name="b8a6" id="b8a6" class="graf graf--li graf-after--li">Backtracking based solution.</li><li name="72c1" id="72c1" class="graf graf--li graf-after--li">Permutations based solution.</li><li name="41e1" id="41e1" class="graf graf--li graf-after--li">Finally, the seemingly crazy solution using Bit Magic.</li></ul><p name="ecc2" id="ecc2" class="graf graf--p graf-after--li">I would highly recommend reading through the solutions in this order. However, feel free to skip a solution if you‚Äôre already familiar with it.</p><p name="5c4c" id="5c4c" class="graf graf--p graf-after--p">The entire code for the solutions discussed below is available <a href="https://github.com/edorado93/Save-The-Queens/tree/master" data-href="https://github.com/edorado93/Save-The-Queens/tree/master" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">here</a>.</p><h3 name="4114" id="4114" class="graf graf--h3 graf-after--p">The Brute Force¬†Solution</h3><pre name="db6e" id="db6e" class="graf graf--pre graf-after--h3">while there is life on earth:<br>    try a possible arrangement of queens.</pre><figure name="6701" id="6701" class="graf graf--figure graf-after--pre"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 525px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 75%;"></div><img class="graf-image" data-image-id="1*Nclg6kDeZ7jWal80xCVt-Q.jpeg" data-width="1440" data-height="1080" src="https://cdn-images-1.medium.com/max/800/1*Nclg6kDeZ7jWal80xCVt-Q.jpeg"></div><figcaption class="imageCaption"><a href="https://i.ytimg.com/vi/keCgNXlq3Vo/maxresdefault.jpg" data-href="https://i.ytimg.com/vi/keCgNXlq3Vo/maxresdefault.jpg" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">https://i.ytimg.com/vi/keCgNXlq3Vo/maxresdefault.jpg</a></figcaption></figure><p name="27e7" id="27e7" class="graf graf--p graf-after--figure">We‚Äôve got an 8x8 chessboard, which means we have 64 different spots to place the queens. We need to calculate C(64, 8), or the <a href="http://www.mathwords.com/c/combination_formula.htm" data-href="http://www.mathwords.com/c/combination_formula.htm" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">number of combinations</a> of 64 objects, taken 8 at a time.</p><pre name="a36b" id="a36b" class="graf graf--pre graf-after--p">C(n,r) = n! / (r!(n‚àír)!)</pre><p name="57aa" id="57aa" class="graf graf--p graf-after--pre">We get around <strong class="markup--strong markup--p-strong">4.5 billion different combinations of placing the 8 queens on an 8x8 chessboard.</strong></p><p name="0945" id="0945" class="graf graf--p graf-after--p">The brute-force algorithm is as follows:</p><pre name="a1d8" id="a1d8" class="graf graf--pre graf-after--p">while there are untried configurations<br>{<br>   generate the next configuration<br>   if queens don&#39;t attack in this configuration then<br>   {<br>      print this configuration;<br>   }<br>}</pre><p name="cc5d" id="cc5d" class="graf graf--p graf-after--pre">That‚Äôs a lot of permutations to check for a standard processor. We could use some sort of multi-processing solution (because checking one permutation is independent of another one).</p><p name="55e9" id="55e9" class="graf graf--p graf-after--p">But why do that when we have better algorithms to solve this problem?</p><h3 name="b3cd" id="b3cd" class="graf graf--h3 graf-after--p">Backtracking</h3><p name="0277" id="0277" class="graf graf--p graf-after--h3">We can do better than the na√Øve brute force solution for this problem. Consider the following pseudocode for the backtracking based solution:</p><pre name="13c3" id="13c3" class="graf graf--pre graf-after--p">1) Start in the leftmost column<br>2) If all queens are placed<br>    increment the number of solutions counter and return<br>3) Try all rows in the current column. Do following for every tried row.<br>    a) If the queen can be placed safely in this row then mark this [row, column] as part of the solution and recursively check if placing queen here leads to a solution.</pre><pre name="d035" id="d035" class="graf graf--pre graf-after--pre">    b) If placing queen in [row, column] leads to a solution then   increment the number of solutions counter and return</pre><pre name="e7f8" id="e7f8" class="graf graf--pre graf-after--pre">    c) If placing queen doesn&#39;t lead to a solution then unmark this [row, column] (Backtrack) and go to step (a) to try other rows.</pre><pre name="fc4f" id="fc4f" class="graf graf--pre graf-after--pre">4) If all rows have been tried and nothing worked, return, to trigger backtracking.</pre><p name="8334" id="8334" class="graf graf--p graf-after--pre">The pseudocode looks simple enough, and you can checkout the python based code for this <a href="http://www.geeksforgeeks.org/backtracking-set-3-n-queen-problem/" data-href="http://www.geeksforgeeks.org/backtracking-set-3-n-queen-problem/" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">here</a>. I won‚Äôt be providing description for the backtracking algorithm here.</p><p name="c514" id="c514" class="graf graf--p graf-after--p">I would however, like to<strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em"> </em></strong>discuss an<strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em"> </em>optimization</strong> to reduce the time complexity of checking if we can place a queen in a cell on the board.</p><p name="4526" id="4526" class="graf graf--p graf-after--p">An important piece of the algorithm is where we have to check if a queen can be placed in a cell <code class="markup--code markup--p-code">[i, j]</code>. This step takes a long time. Let‚Äôs look at a brute-force way to do this, and then at an optimized version.</p><figure name="531c" id="531c" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/edorado93/6c0c29435574f70006a4f548bd5e5d49.js"></script></figure><p name="f9b6" id="f9b6" class="graf graf--p graf-after--figure">This has a <a href="https://www.youtube.com/watch?v=KSNx22U4uWE" data-href="https://www.youtube.com/watch?v=KSNx22U4uWE" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank"><strong class="markup--strong markup--p-strong">time</strong> <strong class="markup--strong markup--p-strong">complexity</strong></a><strong class="markup--strong markup--p-strong"> of O(N),</strong> and this will be called multiple times for every cell on the board.</p><p name="9e17" id="9e17" class="graf graf--p graf-after--p">We can however, make use of some additional data structures to speed up the validity check for placing a queen on a cell <code class="markup--code markup--p-code">[i, j]</code>. This will bring down the complexity to <code class="markup--code markup--p-code">O(1)</code>‚Ää‚Äî‚Ääin other words, constant time. This is a huge reduction!.</p><figure name="5264" id="5264" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/edorado93/3b0cdbd4a3070544fbc332ce7b25175b.js"></script></figure><p name="e261" id="e261" class="graf graf--p graf-after--figure">The keys points in this piece of code are the following¬†:</p><ul class="postList"><li name="83cd" id="83cd" class="graf graf--li graf-after--p">All the elements in a particular diagonal (from left top to right bottom) have the same value for <code class="markup--code markup--li-code">row‚Ää‚Äî‚Ääcolumn</code>¬†.</li><li name="68d2" id="68d2" class="graf graf--li graf-after--li">All the elements in a particular anti-diagonal (from right top to left bottom) have the same value for <code class="markup--code markup--li-code">row + column</code>¬†.</li></ul><p name="6f6d" id="6f6d" class="graf graf--p graf-after--li">This optimization brings down the <code class="markup--code markup--p-code">isSafe</code><em class="markup--em markup--p-em"> </em>complexity to<em class="markup--em markup--p-em"> </em><code class="markup--code markup--p-code"><em class="markup--em markup--p-em">O(1)</em></code><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">. </em></strong>Hurray üòÉ.</p><p name="8bca" id="8bca" class="graf graf--p graf-after--p">Now that we‚Äôre done with the basic algorithms for N-Queens. Let‚Äôs move onto some more complicated ones that run much faster than the ones described above.</p><h3 name="bb19" id="bb19" class="graf graf--h3 graf-after--p">Permutations and¬†N-Queens</h3><p name="2e90" id="2e90" class="graf graf--p graf-after--h3">The idea behind this algorithm is pretty simple. Consider the following facts about the placement of each queen:</p><ul class="postList"><li name="3f01" id="3f01" class="graf graf--li graf-after--p">We can only place one queen in a row.</li><li name="104e" id="104e" class="graf graf--li graf-after--li">Same thing can be said for each column.</li><li name="0283" id="0283" class="graf graf--li graf-after--li">This means that all successful solutions are just going to be <strong class="markup--strong markup--li-strong">permutations of the column subscripts.</strong></li><li name="36c9" id="36c9" class="graf graf--li graf-after--li">Each successive row has one fewer candidate position for the queen to be placed.</li></ul><p name="569c" id="569c" class="graf graf--p graf-after--li">Going by this logic, the problem space comes down to just <strong class="markup--strong markup--p-strong">8! = 40,320.</strong></p><p name="19ba" id="19ba" class="graf graf--p graf-after--p">That gives a lot less options to try and to find the solutions for our problem.</p><p name="cfae" id="cfae" class="graf graf--p graf-after--p">Let‚Äôs look at the pseudo-code for this approach:</p><pre name="daeb" id="daeb" class="graf graf--pre graf-after--p">* Start with an initial permutation of the queens lined up along one of the diagonals. </pre><pre name="3f8a" id="3f8a" class="graf graf--pre graf-after--pre">* To position a queen on row j<br>    * If j has reached N, you have a valid solution. Process it as               valid.<br>    * Loop on k from j to N<br>       * Swap board[j] and board[k]. <br>       * Check if a queen can be placed on (row, board[row])<br>           * If yes, then place a queen and recurse for row j+1<br>       * Undo placing a queen on (row, board[row])<br>   * Undo the swaps done.   </pre><p name="d81f" id="d81f" class="graf graf--p graf-after--pre">For greater clarity, let‚Äôs look at the code as well:</p><figure name="5f12" id="5f12" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/edorado93/814d06ba5a9fa14fe248ce950633c057.js"></script></figure><p name="f37f" id="f37f" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">Note: </strong><code class="markup--code markup--p-code">board[i]</code> stores the column number where a queen has been placed in row <code class="markup--code markup--p-code">i.</code> Hence, the cell value is given by <code class="markup--code markup--p-code">(i, board[i])</code>.</p><p name="e109" id="e109" class="graf graf--p graf-after--p">This optimization speeds up the calculation a lot, because of the highly reduced board space to consider while placing the queens.</p><p name="78fe" id="78fe" class="graf graf--p graf-after--p">The speed up becomes more prominent as we increase the size of the board, and hence the number of queens to be placed.</p><p name="8f7f" id="8f7f" class="graf graf--p graf-after--p">Also, the validity check for a particular cell becomes simpler, because now we only have to check diagonals and the anti-diagonals.</p><h3 name="7275" id="7275" class="graf graf--h3 graf-after--p">Let‚Äôs see some Bit¬†Magic!</h3><p name="b363" id="b363" class="graf graf--p graf-after--h3">This particular solution to the problem is something that was practically Greek to me the first time I went through it.</p><p name="e4da" id="e4da" class="graf graf--p graf-after--p">That‚Äôs understandable though, because hey, it‚Äôs <strong class="markup--strong markup--p-strong">bit</strong> <strong class="markup--strong markup--p-strong">magic!</strong></p><p name="99c0" id="99c0" class="graf graf--p graf-after--p">But thankfully, I found this amazing <a href="http://gregtrowbridge.com/a-bitwise-solution-to-the-n-queens-problem-in-javascript/" data-href="http://gregtrowbridge.com/a-bitwise-solution-to-the-n-queens-problem-in-javascript/" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">blog post</a> explaining the entire algorithm line by line. The code is in JavaScript. I‚Äôll be describing the same thing but for the code in python. Read whichever post suits you¬†:)</p><p name="e0bc" id="e0bc" class="graf graf--p graf-after--p">The best way to go about explaining this algorithm is by putting up the code first üòâ</p><figure name="e2ba" id="e2ba" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/edorado93/3adb5593de64068f1cdd1afabe94e1fd.js"></script></figure><figure name="bc6b" id="bc6b" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 525px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 75%;"></div><img class="graf-image" data-image-id="1*yAqiXTpbu-6mRHQ5SjYn5Q.jpeg" data-width="1024" data-height="768" src="https://cdn-images-1.medium.com/max/800/1*yAqiXTpbu-6mRHQ5SjYn5Q.jpeg"></div><figcaption class="imageCaption"><a href="http://mymemes.biz/wp-content/uploads/2017/10/meme-magic-59df0f3650800.jpg" data-href="http://mymemes.biz/wp-content/uploads/2017/10/meme-magic-59df0f3650800.jpg" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">http://mymemes.biz/wp-content/uploads/2017/10/meme-magic-59df0f3650800.jpg</a></figcaption></figure><p name="6a1b" id="6a1b" class="graf graf--p graf-after--figure">The algorithm works using the same basic idea that was discussed before. We only need to check three things before placing a queen on a certain square:</p><ol class="postList"><li name="e83a" id="e83a" class="graf graf--li graf-after--p">The square‚Äôs column doesn‚Äôt have any other queens on it</li><li name="7e91" id="7e91" class="graf graf--li graf-after--li">The square‚Äôs left diagonal doesn‚Äôt have any other queens on it</li><li name="a53a" id="a53a" class="graf graf--li graf-after--li">The square‚Äôs right diagonal doesn‚Äôt have any other queens on it</li></ol><p name="3d38" id="3d38" class="graf graf--p graf-after--li">The code might look like a black box that just seems to work. That‚Äôs how I felt the first time I read this insanely fast piece of code.</p><p name="3306" id="3306" class="graf graf--p graf-after--p">Let‚Äôs try and break it down line by line.</p><h4 name="a0ef" id="a0ef" class="graf graf--h4 graf-after--p">Line #1</h4><p name="b90f" id="b90f" class="graf graf--p graf-after--h4">You‚Äôll notice that the function accepts 4 parameters:</p><ol class="postList"><li name="04bc" id="04bc" class="graf graf--li graf-after--p">column</li><li name="932f" id="932f" class="graf graf--li graf-after--li">left_diagonal</li><li name="9e51" id="9e51" class="graf graf--li graf-after--li">right_diagonal</li><li name="dd30" id="dd30" class="graf graf--li graf-after--li">queens_placed</li></ol><p name="f044" id="f044" class="graf graf--p graf-after--li">The <code class="markup--code markup--p-code u-paddingRight0 u-marginRight0"><strong class="markup--strong markup--p-strong">queens_placed</strong> </code>is self explanatory. We need to keep track of how many queens we have placed till now for the recursion to terminate at one point.</p><p name="ea1e" id="ea1e" class="graf graf--p graf-after--p">The three variables <code class="markup--code markup--p-code">column</code>, <code class="markup--code markup--p-code">left_diagonal</code> and <code class="markup--code markup--p-code">right_diagonal </code>are basically integers, but they are being treated as a sequence of bits for the purpose of this algorithm. These variables help us determine the open positions on the current row for a queen to be placed.</p><p name="647a" id="647a" class="graf graf--p graf-after--p">Let‚Äôs look at the picture below:</p><ul class="postList"><li name="aa50" id="aa50" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">ld</code> = left_diagonal</li><li name="56cc" id="56cc" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">cols</code> = column</li><li name="a277" id="a277" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">rd</code> = right_diagonal</li></ul><figure name="d164" id="d164" class="graf graf--figure graf-after--li"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 358px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 51.2%;"></div><img class="graf-image" data-image-id="1*u0D6tQbzP98BCTD54GfV9A.png" data-width="1176" data-height="602" src="https://cdn-images-1.medium.com/max/800/1*u0D6tQbzP98BCTD54GfV9A.png"></div><figcaption class="imageCaption"><a href="http://gregtrowbridge.com/a-bitwise-solution-to-the-n-queens-problem-in-javascript/" data-href="http://gregtrowbridge.com/a-bitwise-solution-to-the-n-queens-problem-in-javascript/" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">http://gregtrowbridge.com/a-bitwise-solution-to-the-n-queens-problem-in-javascript/</a></figcaption></figure><p name="0590" id="0590" class="graf graf--p graf-after--figure">Ignore the <code class="markup--code markup--p-code">poss</code><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em"> </em></strong>variable for now. We‚Äôll get to it later on.</p><h4 name="9cec" id="9cec" class="graf graf--h4 graf-after--p">Lines #2‚Äì6</h4><p name="4533" id="4533" class="graf graf--p graf-after--h4">These lines of code simply handle the base case for recursion. When we have placed <code class="markup--code markup--p-code">N</code> queens on our N by N board, we increment the number of solutions counter and print the solution if the appropriate flag has been set while running (see the entire code for this flag).</p><h4 name="0d3a" id="0d3a" class="graf graf--h4 graf-after--p">Line #8</h4><p name="6e53" id="6e53" class="graf graf--p graf-after--h4">This finds the <code class="markup--code markup--p-code">valid_spots</code> remaining on the current row. This is basically the <code class="markup--code markup--p-code">poss</code> variable depicted in the picture above.</p><pre name="07c5" id="07c5" class="graf graf--pre graf-after--p">valid_spots = self.all_ones &amp; <br>~(column | left_diagonal | right_diagonal)</pre><p name="499f" id="499f" class="graf graf--p graf-after--pre">For example, let‚Äôs say that after some number of iterations we have:</p><pre name="6304" id="6304" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">left_diagonal = 00011000<br>column = 11001001</code> <br><code class="markup--code markup--pre-code">right_diagonal = 00011100</code></pre><p name="7784" id="7784" class="graf graf--p graf-after--pre">The code <code class="markup--code markup--p-code">(column | left_diagonal | right_diagonal)</code> just does an ‚ÄúOR‚Äù operation, and ends up with the bit sequence 11011101.</p><p name="728b" id="728b" class="graf graf--p graf-after--p">Then, adding the <code class="markup--code markup--p-code">~</code> in front of that expression causes the resulting bit sequence to ‚Äúflip‚Äù (so all zeroes become ones and vice versa), and <code class="markup--code markup--p-code">valid_spots</code> would be set to 00100010.</p><p name="2f12" id="2f12" class="graf graf--p graf-after--p">So for the current row, the column number 0,1,3,4,5 and 7 are not available. We can only place a queen on column number 2 and 6. These are the only two spots that we will try.</p><h4 name="6504" id="6504" class="graf graf--h4 graf-after--p">Line #10</h4><pre name="372d" id="372d" class="graf graf--pre graf-after--h4">current_spot = -valid_spots &amp; valid_spots</pre><p name="30d9" id="30d9" class="graf graf--p graf-after--pre">This line finds the first non zero bit and stores it into <code class="markup--code markup--p-code">current_spot</code>. So it‚Äôs basically finding the first empty spot where we can place our queen (from the rightmost column).</p><p name="89fe" id="89fe" class="graf graf--p graf-after--p">This right here is what makes the algorithm so fast. We used bit operators to directly tell us the empty positions that are completely safe for us to place our queens. Hence, this leads to major speedup as you will see later on.</p><h4 name="9d24" id="9d24" class="graf graf--h4 graf-after--p">Line #11 and¬†12</h4><p name="dada" id="dada" class="graf graf--p graf-after--h4">Line #11 simply adds the queen being placed at the <code class="markup--code markup--p-code">current_spot</code><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em"> </em></strong>to our solution set so that we can print it later.</p><p name="cb32" id="cb32" class="graf graf--p graf-after--p">Line #12 marks the <code class="markup--code markup--p-code">current_spot</code><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em"> </em></strong>as unavailable. Remember, <a href="https://en.wikipedia.org/wiki/XOR_swap_algorithm" data-href="https://en.wikipedia.org/wiki/XOR_swap_algorithm" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">XORing</a> the same bits leads to 0.</p><h4 name="52c1" id="52c1" class="graf graf--h4 graf-after--p">Line #13</h4><p name="6bf4" id="6bf4" class="graf graf--p graf-after--h4">This is probably the most important line of code for this algorithm (and the most confusing one as well). Here we are just propagating the effects we introduced, further down to the next row.</p><p name="7001" id="7001" class="graf graf--p graf-after--p">We placed a queen at the <code class="markup--code markup--p-code">current_spot</code><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em"> </em></strong>and now we want to update our variables <code class="markup--code markup--p-code">column</code><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">, </em></strong><code class="markup--code markup--p-code">left_diagonal</code><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em"> </em></strong>and<strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em"> </em></strong><code class="markup--code markup--p-code">right_diagonal</code><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em"> </em></strong>to contain these changes as we move onto the next row.</p><pre name="eac9" id="eac9" class="graf graf--pre graf-after--p">self.solve((column | current_spot), (left_diagonal | current_spot)&gt;&gt; 1,(right_diagonal | current_spot) &lt;&lt; 1, queens_placed + 1)</pre><p name="8f66" id="8f66" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">NOTE:</strong> <code class="markup--code markup--p-code">a | b</code> means bitwise OR for variables <code class="markup--code markup--p-code">a</code> and <code class="markup--code markup--p-code">b</code>. Also, <code class="markup--code markup--p-code">a &lt;&lt; 1</code> is a left-shit operator. Similarly, <code class="markup--code markup--p-code">a &gt;&gt; 1</code> is the right-shift operator.</p><p name="78a8" id="78a8" class="graf graf--p graf-after--p">So calling <code class="markup--code markup--p-code">(right_diagonal | current_spot) &lt;&lt; 1</code> simply says: combine <code class="markup--code markup--p-code">right_diagonal</code> and <code class="markup--code markup--p-code">current_spot</code> with an OR operation, then move everything in the result to the left by one.</p><p name="db4a" id="db4a" class="graf graf--p graf-after--p">For example‚Ää‚Äî‚Ääsay <code class="markup--code markup--p-code">right_diagonal</code> had value <code class="markup--code markup--p-code">00011100</code>. And say we made the queen occupy the last slot such as the last 1 in the <code class="markup--code markup--p-code">valid_spots</code><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em"> </em></strong>integer <code class="markup--code markup--p-code">00100010</code>.</p><p name="05f2" id="05f2" class="graf graf--p graf-after--p">Then the <code class="markup--code markup--p-code">current_spot</code> would become <code class="markup--code markup--p-code">000000010</code> and OR-ing it with the <code class="markup--code markup--p-code">right_diagonal</code> would give us <code class="markup--code markup--p-code">00011110.</code> We left-shift it to get <code class="markup--code markup--p-code">00111100</code> and that is exactly the effect we want for the right-diagonal.</p><p name="6eba" id="6eba" class="graf graf--p graf-after--p">The right-diagonal is moving from right top to bottom left. Left-shift on the bits produces that effect.</p><p name="7da9" id="7da9" class="graf graf--p graf-after--p">For a greater clarity, try doing this operation on a paper:</p><figure name="0a07" id="0a07" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 358px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 51.2%;"></div><img class="graf-image" data-image-id="1*u0D6tQbzP98BCTD54GfV9A.png" data-width="1176" data-height="602" src="https://cdn-images-1.medium.com/max/800/1*u0D6tQbzP98BCTD54GfV9A.png"></div><figcaption class="imageCaption">Just so you don‚Äôt have to go up the article¬†üòõ</figcaption></figure><p name="7e79" id="7e79" class="graf graf--p graf-after--figure">We start with 0s for all the three variables, meaning that all the positions are available in the first row for placing the queens.</p><p name="9709" id="9709" class="graf graf--p graf-after--p">Now comes the fun part (well, something to amaze you üòÜ), Speed Comparisons.</p><h3 name="cfa5" id="cfa5" class="graf graf--h3 graf-after--p">Stats</h3><p name="15a9" id="15a9" class="graf graf--p graf-after--h3">Let‚Äôs look at the stats for a tool that Google built for solving the N-Queens.</p><figure name="87d3" id="87d3" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 656px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 93.8%;"></div><img class="graf-image" data-image-id="1*ZDMBCDEaUvQmcL1TO-GJDg.png" data-width="1286" data-height="1206" src="https://cdn-images-1.medium.com/max/800/1*ZDMBCDEaUvQmcL1TO-GJDg.png"></div><figcaption class="imageCaption"><a href="https://developers.google.com/optimization/cp/queens" data-href="https://developers.google.com/optimization/cp/queens" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">https://developers.google.com/optimization/cp/queens</a></figcaption></figure><p name="a179" id="a179" class="graf graf--p graf-after--figure">Following are the stats for the 4 different approaches we discussed for the<br>N-Queens:</p><figure name="726f" id="726f" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 337px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 48.1%;"></div><img class="graf-image" data-image-id="1*3vDf0vC_7O1W-RK94ZS5HQ.png" data-width="1256" data-height="604" src="https://cdn-images-1.medium.com/max/800/1*3vDf0vC_7O1W-RK94ZS5HQ.png"></div><figcaption class="imageCaption">All the times are in¬†ms.</figcaption></figure><figure name="77b7" id="77b7" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 335px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 47.8%;"></div><img class="graf-image" data-image-id="1*-J6QjokBFXvZDOYkTGBTyQ.png" data-width="1254" data-height="600" src="https://cdn-images-1.medium.com/max/800/1*-J6QjokBFXvZDOYkTGBTyQ.png"></div><figcaption class="imageCaption">All the times are in¬†ms.</figcaption></figure><p name="6f09" id="6f09" class="graf graf--p graf-after--figure">The last solution involving bitwise operators clearly performs better than the results reported by the <a href="https://developers.google.com/optimization/cp/queens" data-href="https://developers.google.com/optimization/cp/queens" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Google‚Äôs</a> N-Queens solver. üòÉ</p><p name="e3cd" id="e3cd" class="graf graf--p graf-after--p">Also, an interesting thing to note here is the effect that slight optimization had on the results. Recall the optimization where we converted the <code class="markup--code markup--p-code">is_cell_safe</code>check from an <code class="markup--code markup--p-code">O(N)</code> solution to an <code class="markup--code markup--p-code">O(1)</code> check. This clearly shows us how such small changes can bring about huge performance impacts.</p><p name="b302" id="b302" class="graf graf--p graf-after--p">If you‚Äôve read along till the very end, I‚Äôm sure your algorithmic curiosity has now been satisfied! But hey, this is just the tip of the iceberg üòâ.</p><p name="0f70" id="0f70" class="graf graf--p graf-after--p">I have another post coming up soon where we‚Äôll tackle a problem similar to the N-Queens but with a slight twist.</p><p name="1073" id="1073" class="graf graf--p graf-after--p graf--trailing">Kudos to <a href="https://medium.com/u/3d68fc2a6ecb" data-href="https://medium.com/u/3d68fc2a6ecb" data-anchor-type="2" data-user-id="3d68fc2a6ecb" data-action-value="3d68fc2a6ecb" data-action="show-user-card" data-action-type="hover" class="markup--user markup--p-user" target="_blank">Rahul Gupta</a> for his valuable inputs in the code and the article.</p></div></div></section>
</section>
</article></body></html>-->
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/12/19/How-to-solve-the-Baby-Lizards-Problem-a-fun-twist-on-the-N-Queens-problem-a6980f5e72a/">
        How to solve the Baby Lizards Problem ‚Äî a fun twist on the N-Queens problem
      </a>
    </h1>

    <span class="post-date">19 Dec 2017</span>
  
    
    <!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>How to solve the Baby Lizards Problem ‚Äî a fun twist on the N-Queens problem</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 100%;
        margin: auto;
      }
      section {
        width: 100%;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 100%;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">How to solve the Baby Lizards Problem ‚Äî a fun twist on the N-Queens problem</h1>
</header>
<section data-field="subtitle" class="p-summary">
This problem statement was an assignment as a part of my coursework for the Masters program at USC. I had loads of fun while solving it and‚Ä¶
</section>
<section data-field="body" class="e-content">
<section name="4156" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="8ce7" id="8ce7" class="graf graf--h3 graf--leading graf--title"></h3></div><div class="section-inner sectionLayout--fullWidth"><figure name="cf9b" id="cf9b" class="graf graf--figure graf--layoutFillWidth graf-after--h3"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 100.4%;"></div><img class="graf-image" data-image-id="1*3i2Y2ipYM-aQ_0VSeQ9eoQ.png" data-width="1452" data-height="1458" data-is-featured="true" src="https://cdn-images-1.medium.com/max/2000/1*3i2Y2ipYM-aQ_0VSeQ9eoQ.png"></div><figcaption class="imageCaption"><a href="http://www.csplib.org/Problems/prob079/assets/nqc1850sol2.png" data-href="http://www.csplib.org/Problems/prob079/assets/nqc1850sol2.png" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">http://www.csplib.org/Problems/prob079/assets/nqc1850sol2.png</a></figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="2538" id="2538" class="graf graf--p graf-after--figure">This problem statement was an assignment as a part of my coursework for the Masters program at USC. I had loads of fun while solving it and I decided to share my learnings with the community.
    <br>
    <a href="/2017/12/19/How-to-solve-the-Baby-Lizards-Problem-a-fun-twist-on-the-N-Queens-problem-a6980f5e72a/">
         Read More...
    </a>
    <hr>
    <!--<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>How to solve the Baby Lizards Problem ‚Äî a fun twist on the N-Queens problem</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 100%;
        margin: auto;
      }
      section {
        width: 100%;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 100%;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">How to solve the Baby Lizards Problem ‚Äî a fun twist on the N-Queens problem</h1>
</header>
<section data-field="subtitle" class="p-summary">
This problem statement was an assignment as a part of my coursework for the Masters program at USC. I had loads of fun while solving it and‚Ä¶
</section>
<section data-field="body" class="e-content">
<section name="4156" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="8ce7" id="8ce7" class="graf graf--h3 graf--leading graf--title"></h3></div><div class="section-inner sectionLayout--fullWidth"><figure name="cf9b" id="cf9b" class="graf graf--figure graf--layoutFillWidth graf-after--h3"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 100.4%;"></div><img class="graf-image" data-image-id="1*3i2Y2ipYM-aQ_0VSeQ9eoQ.png" data-width="1452" data-height="1458" data-is-featured="true" src="https://cdn-images-1.medium.com/max/2000/1*3i2Y2ipYM-aQ_0VSeQ9eoQ.png"></div><figcaption class="imageCaption"><a href="http://www.csplib.org/Problems/prob079/assets/nqc1850sol2.png" data-href="http://www.csplib.org/Problems/prob079/assets/nqc1850sol2.png" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">http://www.csplib.org/Problems/prob079/assets/nqc1850sol2.png</a></figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="2538" id="2538" class="graf graf--p graf-after--figure">This problem statement was an assignment as a part of my coursework for the Masters program at USC. I had loads of fun while solving it and I decided to share my learnings with the community.  <p name="cf4a" id="cf4a" class="graf graf--p graf-after--p">Let‚Äôs start with the problem statement.-->
    <!--<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>How to solve the Baby Lizards Problem ‚Äî a fun twist on the N-Queens problem</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 100%;
        margin: auto;
      }
      section {
        width: 100%;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 100%;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">How to solve the Baby Lizards Problem ‚Äî a fun twist on the N-Queens problem</h1>
</header>
<section data-field="subtitle" class="p-summary">
This problem statement was an assignment as a part of my coursework for the Masters program at USC. I had loads of fun while solving it and‚Ä¶
</section>
<section data-field="body" class="e-content">
<section name="4156" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="8ce7" id="8ce7" class="graf graf--h3 graf--leading graf--title"></h3></div><div class="section-inner sectionLayout--fullWidth"><figure name="cf9b" id="cf9b" class="graf graf--figure graf--layoutFillWidth graf-after--h3"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 100.4%;"></div><img class="graf-image" data-image-id="1*3i2Y2ipYM-aQ_0VSeQ9eoQ.png" data-width="1452" data-height="1458" data-is-featured="true" src="https://cdn-images-1.medium.com/max/2000/1*3i2Y2ipYM-aQ_0VSeQ9eoQ.png"></div><figcaption class="imageCaption"><a href="http://www.csplib.org/Problems/prob079/assets/nqc1850sol2.png" data-href="http://www.csplib.org/Problems/prob079/assets/nqc1850sol2.png" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">http://www.csplib.org/Problems/prob079/assets/nqc1850sol2.png</a></figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="2538" id="2538" class="graf graf--p graf-after--figure">This problem statement was an assignment as a part of my coursework for the Masters program at USC. I had loads of fun while solving it and I decided to share my learnings with the community.</p><p name="cf4a" id="cf4a" class="graf graf--p graf-after--p">Let‚Äôs start with the problem statement.</p><h3 name="1ae1" id="1ae1" class="graf graf--h3 graf-after--p">The Problem</h3><p name="5f14" id="5f14" class="graf graf--p graf-after--h3">You are a zookeeper in the reptile house. One of your rare lizards has just had several babies. Your job is to find a place to put each baby lizard in a nursery. However, there is a catch: the baby lizards have very long tongues.</p><p name="26be" id="26be" class="graf graf--p graf-after--p">A baby lizard can shoot out its tongue and eat any other baby lizard before you have time to save it. As such, you want to make sure that no baby lizard can eat another baby lizard in the nursery (burp).</p><p name="ca18" id="ca18" class="graf graf--p graf-after--p">For each baby lizard, you can place them in one spot on a grid. <strong class="markup--strong markup--p-strong">From there, they can shoot out their tongue up, down, left, right and diagonally as well.</strong> Their tongues are very long and can reach to the edge of the nursery from any location.</p><p name="044e" id="044e" class="graf graf--p graf-after--p">Figure 1 shows in what ways a baby lizard can eat another.</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="866d" id="866d" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1000px; max-height: 462px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 46.2%;"></div><img class="graf-image" data-image-id="1*_iiDKlitAjMADtVqlQyapA.png" data-width="1196" data-height="552" src="https://cdn-images-1.medium.com/max/1000/1*_iiDKlitAjMADtVqlQyapA.png"></div><figcaption class="imageCaption">Figure 1 (A) the baby lizard can attack any other lizard in a red square. Thus it can be seen that a baby lizard can eat another lizard to its top, bottom, left right or diagonal. (B) In this example setup, both lizards can eat each other. Your algorithm will try to avoid¬†this.</figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="e2fe" id="e2fe" class="graf graf--p graf-after--figure">In addition to baby lizards, your nursery may have some trees planted in it. Your lizards cannot shoot their tongues through the trees nor can you move a lizard into the same place as a tree.</p><p name="f0c9" id="f0c9" class="graf graf--p graf-after--p">As such, a tree will block any lizard from eating another lizard if it is in the path. Additionally, the tree will block you from moving the lizard to that location.</p><p name="99dc" id="99dc" class="graf graf--p graf-after--p">Figure 2 shows some different valid arrangements of lizards:</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="2ec6" id="2ec6" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1000px; max-height: 455px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 45.5%;"></div><img class="graf-image" data-image-id="1*FBI0AkIOTLeN2EASiZ25Zw.png" data-width="1208" data-height="550" src="https://cdn-images-1.medium.com/max/1000/1*FBI0AkIOTLeN2EASiZ25Zw.png"></div><figcaption class="imageCaption">Figure 2 Both nurseries have valid arrangements of baby lizards such that they cannot eat one¬†<br>another. (A) with no trees, no lizard is in a position to eat another lizard. (B) Two trees are¬†<br>introduced such that the lizard in the last column cannot eat the lizard in the second or fourth¬†<br>column.</figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="5832" id="5832" class="graf graf--p graf-after--figure">Given an arrangement of trees, we need to output a new arrangement of lizards such that no baby lizard can eat another one. You cannot move any of the trees.</p><p name="a4b4" id="a4b4" class="graf graf--p graf-after--p">You can find the entire code for this <a href="https://github.com/edorado93/Save-The-Lizards" data-href="https://github.com/edorado93/Save-The-Lizards" class="markup--anchor markup--p-anchor" rel="noopener nofollow nofollow noopener" target="_blank">here</a>.</p><h3 name="6321" id="6321" class="graf graf--h3 graf-after--p">Similarity to¬†N-Queens</h3><p name="aac3" id="aac3" class="graf graf--p graf-after--h3">This problem is very similar to the classic <a href="https://en.wikipedia.org/wiki/Eight_queens_puzzle" data-href="https://en.wikipedia.org/wiki/Eight_queens_puzzle" class="markup--anchor markup--p-anchor" rel="nofollow noopener noopener" target="_blank">N-Queens Problem</a>. Let‚Äôs recap some of the constraints in the N-Queens problem.</p><ul class="postList"><li name="1f43" id="1f43" class="graf graf--li graf-after--p">There can be only one queen per row and column.</li><li name="1fcf" id="1fcf" class="graf graf--li graf-after--li">There can be only one queen per diagonal and anti-diagonal.</li><li name="5b22" id="5b22" class="graf graf--li graf-after--li">Considering the above 2 constraints, we cannot place more queens than the number of rows or number of columns.</li></ul><p name="cf47" id="cf47" class="graf graf--p graf-after--li">Now, we add in a little twist which says that we have trees at certain location in the nursery (read chess board), and the queens (lizards) on either side of a tree cannot attack each other. This changes things big time.</p><ul class="postList"><li name="20af" id="20af" class="graf graf--li graf-after--p">Now, we can have multiple lizards per row, per column.</li><li name="27c8" id="27c8" class="graf graf--li graf-after--li">Similarly, we can have multiple lizards in a single diagonal or anti-diagonal.</li><li name="00b4" id="00b4" class="graf graf--li graf-after--li">We can place more number of lizards than the number of rows or columns.</li></ul><p name="526d" id="526d" class="graf graf--p graf-after--li">Although the problem looks very similar to the standard puzzle of placing N queens on an N*N board, the solution and the complexity turn out to be very different altogether.</p><p name="af30" id="af30" class="graf graf--p graf-after--p">None of the optimized versions of N-Queens fit in directly for this problem because a lot of the optimizations rely on the simple fact that a solution to the N-Queens problems can be represented as a permutation of column subscripts, simply because we have only one lizard per row, column, diagonal and anti-diagonal. We break this assumption, and the optimizations fall apart.</p><p name="e2cf" id="e2cf" class="graf graf--p graf-after--p">So here in this post, we will discuss a highly optimized backtracking based solution.</p><h3 name="6b34" id="6b34" class="graf graf--h3 graf-after--p">Backtracking++</h3><p name="c1fa" id="c1fa" class="graf graf--p graf-after--h3">The backtracking solution for this problem works in a similar manner to the backtracking solution for the standard N-Queens problem.</p><p name="ced6" id="ced6" class="graf graf--p graf-after--p">The solution for this problem is based on the following idea.</p><p name="db35" id="db35" class="graf graf--p graf-after--p">Given a cell <code class="markup--code markup--p-code">[i, j]</code>, we can either place a lizard, or not place a lizard. Any one of our choices can lead to a solution. So we try both.</p><p name="754e" id="754e" class="graf graf--p graf-after--p">The biggest invariant in this algorithm is that we always move from left to right across the board.</p><p name="25d2" id="25d2" class="graf graf--p graf-after--p">Suppose there is a tree at location [3,4]. Its masking effect (if any) would only be visible once we cross the cell [3,4] in our recursion and move forward. Not before that.</p><p name="bbe9" id="bbe9" class="graf graf--p graf-after--p">Before we get to the actual pseudocode for the problem, there are some other components of the algorithm that I would like to explain. This would make the understanding of the pseudocode much simpler.</p><h3 name="e895" id="e895" class="graf graf--h3 graf-after--p">The Safety Check and the O(1) conundrum</h3><p name="a83c" id="a83c" class="graf graf--p graf-after--h3">If you‚Äôve taken a look at <a href="https://medium.freecodecamp.org/lets-backtrack-and-save-some-queens-1f9ef6af5415" data-href="https://medium.freecodecamp.org/lets-backtrack-and-save-some-queens-1f9ef6af5415" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">my previous article</a> that discusses different algorithmic solutions to the N-Queens puzzle, you might understand what the issue really is.</p><p name="fea4" id="fea4" class="graf graf--p graf-after--p">We get almost 5X speed improvement on a 14 * 14 chessboard where we have to place 14 queens, after converting the safety check function to O(1) from O(N). So it was worth spending time to figure out an algorithm that would tell us in constant time if it is safe to place a queen on a given cell [i, j].</p><p name="ba6b" id="ba6b" class="graf graf--p graf-after--p">For reference, let‚Äôs look at how we did it back in the normal N-Queens.</p><figure name="5264" id="5264" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/edorado93/3b0cdbd4a3070544fbc332ce7b25175b.js"></script><figcaption class="imageCaption">O(1) safety check for N-Queens.</figcaption></figure><p name="d151" id="d151" class="graf graf--p graf-after--figure">We made use of some additional data structures to tell us if a queen had been placed in a certain diagonal, anti-diagonal, row or column in O(1) time and using these we could tell if it was safe to place a queen on a given cell [i, j].</p><p name="fdad" id="fdad" class="graf graf--p graf-after--p">However, if you‚Äôve read through the problem statement carefully, we can now have trees in some locations on the board and if there is a tree between the current cell and an attacker lizard (it can be on a row, column, or any of the two diagonals), then it is in fact safe to place a lizard on the current cell. This is because the tree masks the attack, making the cell safe for a new lizard.</p><p name="b350" id="b350" class="graf graf--p graf-after--p">This changes things, a lot üò±.</p><p name="51dc" id="51dc" class="graf graf--p graf-after--p">Let‚Äôs start with what data structures we need for the implementation.</p><h3 name="e81f" id="e81f" class="graf graf--h3 graf-after--p">The Data Structures Used</h3><figure name="7016" id="7016" class="graf graf--figure graf--iframe graf-after--h3"><script src="https://gist.github.com/edorado93/5a05ee922d0f718eb514715ff6c521fb.js"></script></figure><p name="4b11" id="4b11" class="graf graf--p graf-after--figure">Let‚Äôs go over them one by one.</p><ul class="postList"><li name="689b" id="689b" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code u-paddingRight0 u-marginRight0">tree_locations<strong class="markup--strong markup--li-strong">‚Ää</strong></code>‚Äî‚Ääthis is just a dictionary that tells us if a given cell [i, j] contains a tree. This is populated right at the start of our solver.</li><li name="28f0" id="28f0" class="graf graf--li graf-after--li">The four data structures rows, columns, diagonals and anti-diagonals are used to simply tell us if there is a lizard in the respective <code class="markup--code markup--li-code">r, c, r‚Ää‚Äî‚Ääc, r + c </code>respectively. For this problem however, they represent integer values rather than boolean.<br>These four data structures store either 1 or -1 depending upon if we are placing a lizard at a current cell [i, j] or we are encountering a tree at a given cell [i, j].¬†<br>So the recursion proceeds from one cell to another and can either encounter a tree at a given cell [i, j] or it can encounter an empty cell in which case we have to call the <code class="markup--code markup--li-code">is_cell_safe</code> function to verify if we can place a lizard.<br>I will come to how the values are updated in these four data structures namely <code class="markup--code markup--li-code">rows</code><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">, </em></strong><code class="markup--code markup--li-code">columns</code><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">,</em></strong> <code class="markup--code markup--li-code">diagonals</code> and<strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em"> </em></strong><code class="markup--code markup--li-code">anti-diagonals</code><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em"> </em></strong>later on.</li><li name="efe7" id="efe7" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">is_there_queen_in_this_column</code>‚Äî<strong class="markup--strong markup--li-strong"> </strong>this is a dictionary that simply stores the number of lizards that we placed in a given column. This is used as a part of a pruning heuristic employed to reduce the size of the search space.</li><li name="a123" id="a123" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">next_position_same_column</code><strong class="markup--strong markup--li-strong">‚Ää</strong>‚Äî‚Ääthis tells us for every [i, j] what is the next spot in the same column where we could try and place a new lizard. In the normal N-Queens problem, we can only place a single queen in a column, but in this case we can have multiple queens (lizards).¬†<br>So, after placing a lizard at cell [i, j], we need the location of the first tree in the same column and say that is [k, j]. The next available location for placing a lizard in that column would then be [k+1, j]. This array is used as a part of this optimization.</li><li name="33c9" id="33c9" class="graf graf--li graf-after--li">Finally, <code class="markup--code markup--li-code">is_there_a_tree_ahead</code><strong class="markup--strong markup--li-strong"> </strong>is a dictionary which tells us if there is a tree somewhere in the board after this column (including this column as well). This is also populated once as a part of the initial preprocessing. This is also used as a part of the pruning heuristic referred to above while describing <code class="markup--code markup--li-code">is_there_queen_in_this_column</code>.</li></ul><h3 name="54c0" id="54c0" class="graf graf--h3 graf-after--li">The Preprocess function</h3><figure name="51a7" id="51a7" class="graf graf--figure graf--iframe graf-after--h3"><script src="https://gist.github.com/edorado93/719393f3198f9b7d53315a1de4388bee.js"></script></figure><p name="4279" id="4279" class="graf graf--p graf-after--figure">The preprocess function is called initially before our algorithm starts execution and all it does is fills up some of the data structures discussed above.</p><ul class="postList"><li name="02c5" id="02c5" class="graf graf--li graf-after--p">The <code class="markup--code markup--li-code">trees_populator</code><strong class="markup--strong markup--li-strong"> </strong>function is pretty straightforward. It fills up the dictionaries <code class="markup--code markup--li-code">tree_locations</code><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em"> </em></strong>and <code class="markup--code markup--li-code">is_there_a_tree_ahead</code><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">.</em></strong></li><li name="2bf1" id="2bf1" class="graf graf--li graf-after--li">The function <code class="markup--code markup--li-code">find_next_largest</code><strong class="markup--strong markup--li-strong"> </strong>considers each column as consisting of 0s and 2s where a 0 represents an empty cell and a 2 represents a tree. For every cell, it finds out the next largest element or in other words, the nearest tree to that location in that column. We call the <code class="markup--code markup--li-code">find_next_largest</code><strong class="markup--strong markup--li-strong"> </strong>function<strong class="markup--strong markup--li-strong"> </strong>for every column on the board.</li></ul><p name="9603" id="9603" class="graf graf--p graf-after--li">For a better understanding of this algorithm, refer to <a href="http://www.geeksforgeeks.org/next-greater-element/" data-href="http://www.geeksforgeeks.org/next-greater-element/" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">this overview</a>.</p><h3 name="a5a3" id="a5a3" class="graf graf--h3 graf-after--p"><code class="markup--code markup--h3-code">is_cell_safe</code> Function</h3><figure name="1aab" id="1aab" class="graf graf--figure graf--iframe graf-after--h3"><script src="https://gist.github.com/edorado93/c80cd3ea4c1e5a7bf1444aac02dadc19.js"></script></figure><p name="65eb" id="65eb" class="graf graf--p graf-after--figure">A positive value in any of the dictionaries <code class="markup--code markup--p-code">row</code>, <code class="markup--code markup--p-code">column</code>, <code class="markup--code markup--p-code">diagonal</code>, <code class="markup--code markup--p-code">anti-diagonal</code><strong class="markup--strong markup--p-strong"> </strong>means there is a lizard that is would potentially attack another lizard that we‚Äôre trying to place at [row, column].</p><p name="cd2a" id="cd2a" class="graf graf--p graf-after--p">This function looks very similar to the one we used for the normal N-Queens. The important part is how we update the values in these data structures.</p><h3 name="402a" id="402a" class="graf graf--h3 graf-after--p">Mark Visited, Unmark Visited and Hash¬†Util</h3><figure name="bc9c" id="bc9c" class="graf graf--figure graf--iframe graf-after--h3"><script src="https://gist.github.com/edorado93/a33d3d272c370666b1bd9d1767907ecf.js"></script></figure><p name="109d" id="109d" class="graf graf--p graf-after--figure">The function <code class="markup--code markup--p-code">hash_util</code> is a common function used to update the values for all the four data structures (namely <code class="markup--code markup--p-code">rows</code>, <code class="markup--code markup--p-code">columns</code>, <code class="markup--code markup--p-code">diagonals</code> and <code class="markup--code markup--p-code">anti-diagonals</code>).</p><p name="4cdb" id="4cdb" class="graf graf--p graf-after--p">This function is called both, when we are marking a lizard or a tree, or, when we are unmarking either of them. The marking and unmarking are simply processing before a recursive call and undoing whatever we processed, after the recursive call is over.</p><p name="4e1b" id="4e1b" class="graf graf--p graf-after--p">Remember the invariant discussed in this problem: we move from left to right across the board. Once we have encountered a tree at a certain location (i, j) during the recursion, it would be protecting lizards from each other for all the cells [i+1, j] and all columns k &gt; j.</p><p name="fe4d" id="fe4d" class="graf graf--p graf-after--p">The <code class="markup--code markup--p-code">result</code> variable is very important here. For example, we encountered a tree at say [3,0] and there was a lizard at [1,0]. Now moving onwards, this tree is masking the effect of the lizard at [1,0]‚Ää‚Äî‚Ääat least for this column‚Ää‚Äî‚Ääand we need to bring this effect into consideration somewhere.</p><p name="6dc2" id="6dc2" class="graf graf--p graf-after--p">So, in this case:</p><ul class="postList"><li name="487c" id="487c" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">is_marking</code> = <code class="markup--code markup--li-code">True</code>,</li><li name="8cef" id="8cef" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">is_tree</code> = <code class="markup--code markup--li-code">True</code>,</li><li name="e6b2" id="e6b2" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">dictionary</code> =<code class="markup--code markup--li-code"> column</code>,</li><li name="2fb9" id="2fb9" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">dictionary[col]</code> &gt; 0 (We store 1 whenever we place a lizard in that column). This is because we have already placed a lizard in the column 0 (at 1,0) and there was no tree discovered earlier that would hide the lizard‚Äôs effect for cell [3,0] in our example.</li><li name="22a7" id="22a7" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">value_to_add</code> = -1 (For a tree it‚Äôs -1, for a lizard it‚Äôs 1)</li></ul><p name="c8be" id="c8be" class="graf graf--p graf-after--li">So now, <code class="markup--code markup--p-code">dictionary[col]</code> = -1 and we return 1 as the result meaning that encountering a tree in the given (row, column) did in fact have some masking effect. We need to record this masking effect because this would be used at the time of undoing after recursion.</p><p name="c0e0" id="c0e0" class="graf graf--p graf-after--p">Now consider two other functions that form the main component of the algorithm.</p><figure name="06b5" id="06b5" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/edorado93/dc52a456f3f7f9f16a0f32feb535214c.js"></script></figure><h4 name="8c4e" id="8c4e" class="graf graf--h4 graf-after--figure">Mark Visited</h4><p name="ea8e" id="ea8e" class="graf graf--p graf-after--h4">We call this function in two cases. One is when we encounter a tree, and one is when we want to place a lizard. So, accordingly we have used a boolean variable to tell us why this function has been called.</p><p name="1fc5" id="1fc5" class="graf graf--p graf-after--p">In the case of a tree, we set the value to -1, otherwise it‚Äôs +1. Then, we update the four data structures. The logic is the same for all four of them. It‚Äôs just the key that changes for each one.</p><p name="58a6" id="58a6" class="graf graf--p graf-after--p">Remember, <code class="markup--code markup--p-code">row‚Ää‚Äî‚Ääcol</code> is used to uniquely identify a diagonal and <code class="markup--code markup--p-code">row + col</code>is used to uniquely identify an anti-diagonal.</p><p name="659a" id="659a" class="graf graf--p graf-after--p">Also note that we store the quadruple of return values for the four data structures in <code class="markup--code markup--p-code">did_tree_affect</code><strong class="markup--strong markup--p-strong"> </strong>dictionary. This let‚Äôs us know if encountering a tree at the location (row, col) had any effect at all i.e. masking. This data is used during the undo operation.</p><h4 name="a217" id="a217" class="graf graf--h4 graf-after--p">Unmark Visited</h4><p name="8898" id="8898" class="graf graf--p graf-after--h4">We know that a positive value in any of the four dictionaries means that the given cell is not safe to place a lizard.</p><p name="aa6e" id="aa6e" class="graf graf--p graf-after--p">The undo operation is pretty simple for <strong class="markup--strong markup--p-strong">a lizard</strong>. If we are calling <code class="markup--code markup--p-code">unmark_visited</code> function for a lizard, it means the cell was safe enough before we placed a lizard there, so we just put a value of -1 in all the four dictionaries. (Remember, a positive value in either of rows, columns, diagonals or antidiagonals would break the <code class="markup--code markup--p-code">is_cell_safe</code> function for that cell)</p><p name="5b6e" id="5b6e" class="graf graf--p graf-after--p">In case the function <code class="markup--code markup--p-code">unmark_visited</code> was called for a tree, we retrieve values from <code class="markup--code markup--p-code">did_tree_affect</code> for the given [row, col] and use these values to revert the dictionaries. The sense in this is that suppose that we encountered a tree at given [row, col] and it masked the lizard‚Äôs effect for the diagonal and the column moving forward. See the following figure:</p><figure name="84c3" id="84c3" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 487px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 69.6%;"></div><img class="graf-image" data-image-id="1*WmD5HS5AIdMrSB3-n6oipg.png" data-width="1098" data-height="764" src="https://cdn-images-1.medium.com/max/800/1*WmD5HS5AIdMrSB3-n6oipg.png"></div><figcaption class="imageCaption">The two highlighted cells are masked by the Tree. However, there is no masking effect generated by the Tree for the row and the anti-diagonal.</figcaption></figure><p name="8e38" id="8e38" class="graf graf--p graf-after--figure">When we have to revert seeing the tree in the recursion, we basically have to revert it‚Äôs masking effect. That is what the <code class="markup--code markup--p-code">did_tree_affect</code> dictionary is used for.</p><p name="e1aa" id="e1aa" class="graf graf--p graf-after--p">Now that we have all our dictionaries in place, we can finally look at the actual DFS function that does all our heavy lifting for finding a solution.</p><h3 name="006f" id="006f" class="graf graf--h3 graf-after--p">Backtracking Solver</h3><p name="658c" id="658c" class="graf graf--p graf-after--h3">The code is seemingly complicated and the post would get extremely long if I started explaining it in detail. I might be able to clarify the doubts in the comments section. For now, I‚Äôll write a detailed version of the pseudocode for completion.</p><pre name="0c2a" id="0c2a" class="graf graf--pre graf-after--p">1. Start at the cell (0, 0)</pre><pre name="756c" id="756c" class="graf graf--pre graf-after--pre">2. For a given cell (i, j)<br>     a. If all the lizards have been placed, print the solution and return True.</pre><pre name="9de9" id="9de9" class="graf graf--pre graf-after--pre">b. Check if the current cell has a tree. <br>         b1. Call mark_visited function to update the 4 dictionaries with possible masking effects due to this tree.</pre><pre name="0776" id="0776" class="graf graf--pre graf-after--pre">c. If the current cell isn&#39;t a tree and a lizard can be placed<br>         c1. Call mark visited for [i, j] as a lizard.<br>         c2. Add [i, j] to the solution set. <br>         c3. Increment column j as containing one more lizard.<br>         c4. Find the next row number to recurse on in the column j. If there is such a row number say r, then recurse on [r, j]. Else recurse on [0, j+1]<br>         c5. Unmark the current cell. Call function unmark_visited for [i, j]<br>         c6. Decrement column j as it contains one less lizard now.</pre><pre name="345f" id="345f" class="graf graf--pre graf-after--pre">d. We may want to have a branch in our recursive solution where we did not place a lizard at [i, j] and simply moved forward. OR, we couldn&#39;t place a lizard at [i, j] and we now have to move forward. <br>         d1. if [i + 1] &lt; n, recurse on [i+1, j]<br>         d2. else [PRUNING HEURISTIC]<br>              d2.1 check if <br>                   * we did not place any lizard in the current col.<br>                   * there is no tree in the current col and ahead. <br>                   * number of lizards left to be placed are more than the number of columns left. <br>                   * If yes to all 3, then BACKTRACK.<br>              d2.2 Else, recurse on [0, j+1]</pre><pre name="c597" id="c597" class="graf graf--pre graf-after--pre">e. If the current cell was in-fact a tree, then call unmark_visited to undo its effects.</pre><p name="53e7" id="53e7" class="graf graf--p graf-after--pre">That is the most apt pseudocode that I could come up with for the DFS based solver. This is exactly how the function <code class="markup--code markup--p-code">dfs</code><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em"> </em></strong>is structured.</p><p name="fecd" id="fecd" class="graf graf--p graf-after--p">With this logic, the largest test-case that I was able to solve was to place 97,000 lizards on a 1000 * 1000 board. It took around 2 seconds to run.</p><figure name="86a6" id="86a6" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 655px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 93.60000000000001%;"></div><img class="graf-image" data-image-id="1*Pbn-wAU4pWiRQIee8vCGTg.jpeg" data-width="768" data-height="719" src="https://cdn-images-1.medium.com/max/800/1*Pbn-wAU4pWiRQIee8vCGTg.jpeg"></div><figcaption class="imageCaption"><a href="http://bit.ly/2j6x5KQ" data-href="http://bit.ly/2j6x5KQ" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">http://bit.ly/2j6x5KQ</a></figcaption></figure><p name="20ec" id="20ec" class="graf graf--p graf-after--figure">Now I‚Äôm telling you, that this might sound like a huge feat, but it isn‚Äôt actually. This was pretty easy for the algorithm. Question for you guys is to figure out the why behind this üòâ. Let me know in the comment section¬†!</p><p name="934b" id="934b" class="graf graf--p graf-after--p">Also, if you do come up with some other simpler approach to solve the problem, I would love to discuss that as well. Let me know in the comment section itself.</p><p name="ab94" id="ab94" class="graf graf--p graf-after--p graf--trailing">Hope you liked the article and enjoyed as much I did while solving this problem. If you liked this post, do spread the love (‚ù§) as much as possible. Cheers!</p></div></div></section>
</section>
</article></body></html>-->
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/12/10/Deep-Dive-Into-Graph-Traversals-227a90c6a261/">
        Deep Dive Into Graph Traversals
      </a>
    </h1>

    <span class="post-date">10 Dec 2017</span>
  
    
    <!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Deep Dive Into Graph Traversals</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 100%;
        margin: auto;
      }
      section {
        width: 100%;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 100%;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Deep Dive Into Graph Traversals</h1>
</header>
<section data-field="subtitle" class="p-summary">
There are over 2.07 billion monthly active Facebook Users worldwide as of Q3 2017. The most important aspect of the Facebook network is the‚Ä¶
</section>
<section data-field="body" class="e-content">
<section name="9d62" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="a9f9" id="a9f9" class="graf graf--h3 graf--leading graf--title"></h3></div><div class="section-inner sectionLayout--fullWidth"><figure name="3088" id="3088" class="graf graf--figure graf--layoutFillWidth graf-after--h3"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 74.2%;"></div><img class="graf-image" data-image-id="1*Pebp8Cds-RLs417qaOS_8A.png" data-width="2747" data-height="2039" src="https://cdn-images-1.medium.com/max/2000/1*Pebp8Cds-RLs417qaOS_8A.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="61e6" id="61e6" class="graf graf--p graf-after--figure">There are over 2.07 billion monthly active Facebook Users worldwide as of Q3 2017. The most important aspect of the Facebook network is the social engagement between users. The more friends a user has, the more engaging the conversations become via comments on posts, messaging etc. If you‚Äôve used Facebook fairly regularly, you must be knowing about the Friends Recommendation feature.
    <br>
    <a href="/2017/12/10/Deep-Dive-Into-Graph-Traversals-227a90c6a261/">
         Read More...
    </a>
    <hr>
    <!--<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Deep Dive Into Graph Traversals</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 100%;
        margin: auto;
      }
      section {
        width: 100%;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 100%;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Deep Dive Into Graph Traversals</h1>
</header>
<section data-field="subtitle" class="p-summary">
There are over 2.07 billion monthly active Facebook Users worldwide as of Q3 2017. The most important aspect of the Facebook network is the‚Ä¶
</section>
<section data-field="body" class="e-content">
<section name="9d62" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="a9f9" id="a9f9" class="graf graf--h3 graf--leading graf--title"></h3></div><div class="section-inner sectionLayout--fullWidth"><figure name="3088" id="3088" class="graf graf--figure graf--layoutFillWidth graf-after--h3"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 74.2%;"></div><img class="graf-image" data-image-id="1*Pebp8Cds-RLs417qaOS_8A.png" data-width="2747" data-height="2039" src="https://cdn-images-1.medium.com/max/2000/1*Pebp8Cds-RLs417qaOS_8A.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="61e6" id="61e6" class="graf graf--p graf-after--figure">There are over 2.07 billion monthly active Facebook Users worldwide as of Q3 2017. The most important aspect of the Facebook network is the social engagement between users. The more friends a user has, the more engaging the conversations become via comments on posts, messaging etc. If you‚Äôve used Facebook fairly regularly, you must be knowing about the Friends Recommendation feature.  <p name="11b0" id="11b0" class="graf graf--p graf-after--p">Facebook recommends a set of people that we can add as friends. Most of the times, these are people we‚Äôve never heard of before. But still, Facebook thinks that we should add them. The question is: <strong class="markup--strong markup--p-strong">how does Facebook come up with a set of recommendations for a specific person</strong>?-->
    <!--<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Deep Dive Into Graph Traversals</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 100%;
        margin: auto;
      }
      section {
        width: 100%;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 100%;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Deep Dive Into Graph Traversals</h1>
</header>
<section data-field="subtitle" class="p-summary">
There are over 2.07 billion monthly active Facebook Users worldwide as of Q3 2017. The most important aspect of the Facebook network is the‚Ä¶
</section>
<section data-field="body" class="e-content">
<section name="9d62" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="a9f9" id="a9f9" class="graf graf--h3 graf--leading graf--title"></h3></div><div class="section-inner sectionLayout--fullWidth"><figure name="3088" id="3088" class="graf graf--figure graf--layoutFillWidth graf-after--h3"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 74.2%;"></div><img class="graf-image" data-image-id="1*Pebp8Cds-RLs417qaOS_8A.png" data-width="2747" data-height="2039" src="https://cdn-images-1.medium.com/max/2000/1*Pebp8Cds-RLs417qaOS_8A.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="61e6" id="61e6" class="graf graf--p graf-after--figure">There are over 2.07 billion monthly active Facebook Users worldwide as of Q3 2017. The most important aspect of the Facebook network is the social engagement between users. The more friends a user has, the more engaging the conversations become via comments on posts, messaging etc. If you‚Äôve used Facebook fairly regularly, you must be knowing about the Friends Recommendation feature.</p><p name="11b0" id="11b0" class="graf graf--p graf-after--p">Facebook recommends a set of people that we can add as friends. Most of the times, these are people we‚Äôve never heard of before. But still, Facebook thinks that we should add them. The question is: <strong class="markup--strong markup--p-strong">how does Facebook come up with a set of recommendations for a specific person</strong>?</p><p name="1973" id="1973" class="graf graf--p graf-after--p">One way to do this is based on mutual friends. eg:- If a user A and C don‚Äôt know each other, but they have a mutual friend B, then probably A and C should be friends too. What if A and C have 2 mutual friends and A and D have 3 mutual friends? How will the ordering be for suggestions?</p><p name="bcd2" id="bcd2" class="graf graf--p graf-after--p">In this case, it seems pretty obvious to suggest D over C to A because they have more mutual friends and are more likely to get connected.</p><p name="4cfc" id="4cfc" class="graf graf--p graf-after--p">However, two people might not always have mutual friends, but they might have common 2nd-degree or 3rd-degree connections.</p><h3 name="8184" id="8184" class="graf graf--h3 graf-after--p">Nth Degree Connections</h3><ul class="postList"><li name="414f" id="414f" class="graf graf--li graf-after--h3">A and B are friends. <strong class="markup--strong markup--li-strong">(0 degree)</strong></li><li name="66ca" id="66ca" class="graf graf--li graf-after--li">A and B are <strong class="markup--strong markup--li-strong">1st-degree</strong> friends means they have a mutual friend.</li><li name="ce5c" id="ce5c" class="graf graf--li graf-after--li">A and B are <strong class="markup--strong markup--li-strong">2nd-degree </strong>friends if they have a friend, who is a 1st-degree friend with the other person. eg:- A‚Ää‚Äî‚ÄäC‚Ää‚Äî‚ÄäD‚Ää‚Äî‚ÄäB, then A and B are 2nd-degree friends.</li><li name="caa8" id="caa8" class="graf graf--li graf-after--li">Similarly, A and B are <strong class="markup--strong markup--li-strong">Nth degree </strong>friends if they have N connections in between. eg:- A‚Ää‚Äî‚ÄäX1‚Ää‚Äî‚ÄäX2‚Ää‚Äî‚ÄäX3‚Ä¶..‚Ää‚Äî‚ÄäXN‚Ää‚Äî‚ÄäB.</li></ul><p name="3d40" id="3d40" class="graf graf--p graf-after--li">Looking at this approach for the recommendation, we need to be able to find the degree of friendship that two given users share on Facebook.</p><h3 name="8bcb" id="8bcb" class="graf graf--h3 graf-after--p">Enter Graph Traversals</h3><p name="1e59" id="1e59" class="graf graf--p graf-after--h3">Now that we know how Friend Recommendations can be made, let‚Äôs restate this problem so that we can look at it from an algorithmic perspective.</p><p name="d0ae" id="d0ae" class="graf graf--p graf-after--p">Let‚Äôs imagine an undirected graph of all the users on Facebook<strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">, </em></strong>where vertices <strong class="markup--strong markup--p-strong">V </strong>represent the users and edges <strong class="markup--strong markup--p-strong">E </strong>represent friendships. In other words: if users A and B are friends on Facebook, there is an edge between vertices A and B. The challenge is to find out the degree of connection between any two users.</p><p name="e414" id="e414" class="graf graf--p graf-after--p">More formally, we need to see the shortest distance between two nodes in an undirected, unweighted graph.</p><figure name="0ddd" id="0ddd" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 600px; max-height: 600px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 100%;"></div><img class="graf-image" data-image-id="1*KoGmDyC-0hlueEpG_0HJNw.png" data-width="600" data-height="600" src="https://cdn-images-1.medium.com/max/800/1*KoGmDyC-0hlueEpG_0HJNw.png"></div></figure><p name="d748" id="d748" class="graf graf--p graf-after--figure">Consider two vertices in this undirected graph A and C. There are two different paths for reaching C:</p><p name="93bb" id="93bb" class="graf graf--p graf-after--p">1. A ‚Üí B ‚Üí C and¬†<br>2. A ‚Üí G ‚ÜíF ‚Üí E ‚ÜíD ‚ÜíC</p><p name="01b3" id="01b3" class="graf graf--p graf-after--p">Clearly, we want to take the smallest path when trying to see the degree of connection between two people on the social network.</p><p name="d471" id="d471" class="graf graf--p graf-after--p">So far so good.</p><p name="3c3a" id="3c3a" class="graf graf--p graf-after--p">Before proceeding, let‚Äôs look at the complexity of this problem. As stated before, Facebook has around 2.07 billion users as of Q3 2017. That means our graph will have around 2.07 billion nodes and at least (2.07 billion‚Ää‚Äî‚Ää1) edges (if every person has at least one friend)<strong class="markup--strong markup--p-strong">.</strong></p><p name="e495" id="e495" class="graf graf--p graf-after--p">This is a huge scale to solve this problem on. Additionally, we also saw that there might be multiple paths to reach from a given source vertex to a destination vertex in the graph and we want the shortest one to solve our problem.</p><p name="19f0" id="19f0" class="graf graf--p graf-after--p">We will look at two classic graph traversal algorithms to solve our problem:</p><p name="4d15" id="4d15" class="graf graf--p graf-after--p">1. Depth First Search and¬†<br>2. Breadth First Search.</p><h3 name="cb5b" id="cb5b" class="graf graf--h3 graf-after--p">Depth First¬†Search</h3><p name="3b08" id="3b08" class="graf graf--p graf-after--h3">Imagine that you get stuck in a maze like this.</p><figure name="a3e4" id="a3e4" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 711px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 101.49999999999999%;"></div><img class="graf-image" data-image-id="1*QY2TR83UiZlqXF1mRes2rA.png" data-width="2330" data-height="2365" src="https://cdn-images-1.medium.com/max/800/1*QY2TR83UiZlqXF1mRes2rA.png"></div></figure><p name="9433" id="9433" class="graf graf--p graf-after--figure">You have to get out somehow. There might be multiple routes from your starting position to the exit. The natural approach to getting out of the maze is to try all the paths.</p><p name="821f" id="821f" class="graf graf--p graf-after--p">Let‚Äôs say you have two choices at the point where you are currently standing. Obviously, you don‚Äôt know which one leads out of the maze. So you decide to make the first choice and move onwards in the maze.</p><p name="739d" id="739d" class="graf graf--p graf-after--p">You keep making moves and you keep moving forward and you hit a dead end. Now you would ideally want to try a different path, and so you <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">backtrack </em></strong>to a previous checkpoint where you made one of the choices and then you try a new one i.e. a different path this time.</p><p name="5475" id="5475" class="graf graf--p graf-after--p">You keep doing this until you find the exit.</p><p name="169e" id="169e" class="graf graf--p graf-after--p">Recursively trying out a specific path and backtracking are the two components forming the <strong class="markup--strong markup--p-strong">Depth First Search algorithm </strong>(DFS).</p><p name="25af" id="25af" class="graf graf--p graf-after--p">If we model the maze problem as a graph, the vertices would represent the individual‚Äôs position on the maze and directed edges between two nodes would represent a single move from one position to another position. Using DFS, the individual would try all possible routes until the exit is found.</p><p name="5e83" id="5e83" class="graf graf--p graf-after--p">Here is a sample pseudo-code for the same.</p><pre name="3783" id="3783" class="graf graf--pre graf-after--p">1  <strong class="markup--strong markup--pre-strong">procedure</strong> DFS(<em class="markup--em markup--pre-em">G</em>,<em class="markup--em markup--pre-em">v</em>):<br>2      label <em class="markup--em markup--pre-em">v</em> as discovered<br>3      <strong class="markup--strong markup--pre-strong">for all</strong> edges from <em class="markup--em markup--pre-em">v</em> to <em class="markup--em markup--pre-em">w</em> <strong class="markup--strong markup--pre-strong">in</strong> <em class="markup--em markup--pre-em">G</em>.adjacentEdges(<em class="markup--em markup--pre-em">v</em>) <strong class="markup--strong markup--pre-strong">do</strong><br>4          <strong class="markup--strong markup--pre-strong">if</strong> vertex <em class="markup--em markup--pre-em">w</em> is not labeled as discovered <strong class="markup--strong markup--pre-strong">then</strong><br>5              recursively call DFS(<em class="markup--em markup--pre-em">G</em>,<em class="markup--em markup--pre-em">w</em>)</pre><p name="ce55" id="ce55" class="graf graf--p graf-after--pre">For a deeper dive into this algorithm, check out¬†:-</p><div name="8e43" id="8e43" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/basecs/deep-dive-through-a-graph-dfs-traversal-8177df5d0f13" data-href="https://medium.com/basecs/deep-dive-through-a-graph-dfs-traversal-8177df5d0f13" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/basecs/deep-dive-through-a-graph-dfs-traversal-8177df5d0f13"><strong class="markup--strong markup--mixtapeEmbed-strong">Deep Dive Through A Graph: DFS Traversal</strong><br><em class="markup--em markup--mixtapeEmbed-em">For better or for worse, there‚Äôs always more than one way to do something. Luckily for us, in the world of software and‚Ä¶</em>medium.com</a></div><p name="1636" id="1636" class="graf graf--p graf-after--mixtapeEmbed">Time Complexity: O(V + E)</p><h3 name="1a5d" id="1a5d" class="graf graf--h3 graf-after--p">Breadth First¬†Search</h3><p name="7eac" id="7eac" class="graf graf--p graf-after--h3">Imagine a contagious disease gradually spreading across a region. Every day, the people who have the illness infect new people they come into physical contact with. In this way, the disease is doing a sort of <strong class="markup--strong markup--p-strong">breadth-first-search</strong>(BFS) over the population. The ‚Äúqueue‚Äù is the set of people who have just been infected. The graph is the physical contact network of the region.</p><p name="88f3" id="88f3" class="graf graf--p graf-after--p">Imagine you need to simulate the spread of the disease through this network. The root node of the search is patient zero, the first known sufferer of the disease. You start off with just them with the disease, and no one else.</p><p name="2244" id="2244" class="graf graf--p graf-after--p">Now you iterate over the people they are in contact with. Some will catch the disease. Now iterate over all of them. Give the people they‚Äôre in contact with the disease too, unless they‚Äôve already had it. Keep going until you‚Äôve infected everyone, or you‚Äôve infected your target. Then you‚Äôre done. That‚Äôs how breadth-first-search works.</p><figure name="02cd" id="02cd" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 418px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 59.8%;"></div><img class="graf-image" data-image-id="1*iY5TrjCxKqTjA6mq-gR8pg.png" data-width="1288" data-height="770" src="https://cdn-images-1.medium.com/max/800/1*iY5TrjCxKqTjA6mq-gR8pg.png"></div></figure><p name="b6b4" id="b6b4" class="graf graf--p graf-after--figure">The BFS search algorithm explores vertices layer by layer starting at the very first vertex and only moving on to the next layer once all vertices on the current layer have been processed.</p><p name="18e1" id="18e1" class="graf graf--p graf-after--p">Here is a sample pseudo-code for BFS.</p><pre name="2975" id="2975" class="graf graf--pre graf-after--p">1   <strong class="markup--strong markup--pre-strong">procedure BFS(</strong><em class="markup--em markup--pre-em">G, v</em><strong class="markup--strong markup--pre-strong">):<br></strong>2       q = Queue()<br>3       q.<strong class="markup--strong markup--pre-strong">enqueue(v)</strong><br>4       <strong class="markup--strong markup--pre-strong">while</strong> q is not empty:<br>5            v = q.dequeue()<br>6            if v is <strong class="markup--strong markup--pre-strong">not visited:<br></strong>7               mark v as visited (// Process the node)<br>8               <strong class="markup--strong markup--pre-strong">for all</strong> edges from <em class="markup--em markup--pre-em">v</em> to <em class="markup--em markup--pre-em">w</em> <strong class="markup--strong markup--pre-strong">in</strong> <em class="markup--em markup--pre-em">G</em>.adjacentEdges(<em class="markup--em markup--pre-em">v</em>) <strong class="markup--strong markup--pre-strong">do<br></strong>9                    q.enqueue(w)</pre><p name="be64" id="be64" class="graf graf--p graf-after--pre">For a deeper understanding of BFS, look into <a href="https://medium.com/basecs/going-broad-in-a-graph-bfs-traversal-959bd1a09255" data-href="https://medium.com/basecs/going-broad-in-a-graph-bfs-traversal-959bd1a09255" class="markup--anchor markup--p-anchor" target="_blank">this article</a>.</p><p name="bd47" id="bd47" class="graf graf--p graf-after--p">Time Complexity: O(V + E)</p><h3 name="5c65" id="5c65" class="graf graf--h3 graf-after--p">Shortest Paths</h3><p name="0f0e" id="0f0e" class="graf graf--p graf-after--h3">Let‚Äôs move forward and solve our original problem: finding the shortest path between two given vertices in an undirected graph.</p><p name="797d" id="797d" class="graf graf--p graf-after--p">Looking at the time complexities of the two algorithms, we can‚Äôt really make out the difference between the two for this problem. Both the algorithms will find a path (or rather the shortest path) to our destination from the given source.</p><p name="f42d" id="f42d" class="graf graf--p graf-after--p">Let‚Äôs look at the following example.</p><figure name="be7b" id="be7b" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 583px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 83.39999999999999%;"></div><img class="graf-image" data-image-id="1*YQ1t6ZVjdR9rNvpegFC4Qg.png" data-width="2000" data-height="1667" src="https://cdn-images-1.medium.com/max/800/1*YQ1t6ZVjdR9rNvpegFC4Qg.png"></div></figure><p name="fdeb" id="fdeb" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">Suppose we want to find out the shortest path from the node 8 to 10</strong>. Let‚Äôs look at the nodes that DFS and BFS explore before reaching the destination.</p><h4 name="d3ba" id="d3ba" class="graf graf--h4 graf-after--p">DFS</h4><ul class="postList"><li name="c48c" id="c48c" class="graf graf--li graf-after--h4"><strong class="markup--strong markup--li-strong">Process</strong> 8 ‚Üí <strong class="markup--strong markup--li-strong">Process</strong> 3 ‚Üí <strong class="markup--strong markup--li-strong">Process</strong> 1.</li><li name="b7f3" id="b7f3" class="graf graf--li graf-after--li">Backtrack to 3.</li><li name="01d2" id="01d2" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Process</strong> 6 ‚Üí <strong class="markup--strong markup--li-strong">Process</strong> 4.</li><li name="6043" id="6043" class="graf graf--li graf-after--li">Backtrack to 6.</li><li name="86fe" id="86fe" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Process</strong> 7.</li><li name="2dd9" id="2dd9" class="graf graf--li graf-after--li">Backtrack to 6 ‚Üí Backtrack to 3 ‚Üí Backtrack to 8.</li><li name="6238" id="6238" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Process 10</strong>.</li></ul><p name="fd6e" id="fd6e" class="graf graf--p graf-after--li">A total of 7 nodes are being processed here before the destination is reached. Now let‚Äôs look at how BFS does things.</p><h4 name="14e9" id="14e9" class="graf graf--h4 graf-after--p">BFS</h4><ul class="postList"><li name="0235" id="0235" class="graf graf--li graf-after--h4"><strong class="markup--strong markup--li-strong">Process</strong> 8 ‚Üí Enqueue 3, 10</li><li name="cfb1" id="cfb1" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Process</strong> 3 ‚Üí Enqueue 1,6</li><li name="f664" id="f664" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Process</strong> 10.</li></ul><p name="b666" id="b666" class="graf graf--p graf-after--li">Woah, that was fast! Just 3 nodes had to be processed and we were at our destination.</p><p name="8908" id="8908" class="graf graf--p graf-after--p">The explanation for this speedup that we can see in BFS and not in DFS is because DFS takes up a specific path and goes till the very end i.e. until it hits a dead end and then backtracks.</p><p name="e75e" id="e75e" class="graf graf--p graf-after--p">This is the major downfall of the DFS algorithm. It might have to expand 1000s of levels (in a huge network like that of Facebook, just because it selected a bad path to process in the very beginning) before reaching the path containing our destination. BFS doesn‚Äôt face this problem and hence is much faster for our problem.</p><p name="e4c2" id="e4c2" class="graf graf--p graf-after--p">Additionally, even if DFS finds out the destination, we cannot be sure that the path taken by DFS is the shortest one. There might be other paths as well.</p><p name="afee" id="afee" class="graf graf--p graf-after--p">That means that in any case, for the shortest paths problem, DFS would have to span the entire graph to get the shortest path.</p><p name="dd66" id="dd66" class="graf graf--p graf-after--p">In the case of BFS, however, the first occurrence of the destination node ensures that it is the one at the shortest distance from the source.</p><h3 name="6f30" id="6f30" class="graf graf--h3 graf-after--p">Conclusion</h3><p name="d7d6" id="d7d6" class="graf graf--p graf-after--h3">So far we discussed the problem of Friends Recommendation by Facebook and we boiled it down to the problem of finding the degree of connections between two users in the network graph.</p><p name="ca37" id="ca37" class="graf graf--p graf-after--p">Then we discussed two interesting Graph Traversal algorithms that are very commonly used. Finally, we looked at which algorithm performs the best for solving our problem.</p><p name="411a" id="411a" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Breadth First Search is the algorithm you want to use if you have to find the shortest distance between two nodes in an undirected, unweighted graph.</strong></p><p name="8479" id="8479" class="graf graf--p graf-after--p">Let‚Äôs look at <a href="https://leetcode.com/problems/minimum-genetic-mutation/description/" data-href="https://leetcode.com/problems/minimum-genetic-mutation/description/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">this fun problem</a> to depict the difference between the two algorithms.</p><p name="a4be" id="a4be" class="graf graf--p graf-after--p">Assuming that you‚Äôve read the problem statement carefully, let‚Äôs try and model this as a graph problem in the first place.</p><p name="8a0b" id="8a0b" class="graf graf--p graf-after--p">Let all possible strings become nodes in the graph and we have an edge between two vertices if they have a single mutation between them.</p><p name="e6d1" id="e6d1" class="graf graf--p graf-after--p">Easy, right?</p><p name="6e52" id="6e52" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">We are given a starting string (read source vertext) eg:- ‚ÄúAACCGGTT‚Äù and we have to reach the destination string (read destination vertex) ‚ÄúAACCGGTA‚Äù in minimum number of mutations (read minimum number of steps) such that all intermediate strings (nodes) should belong to the given word bank.</em></p><p name="58a8" id="58a8" class="graf graf--p graf-after--p">Try and solve this problem on your own before looking at the solution below.</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="c369" id="c369" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1000px; max-height: 505px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 50.5%;"></div><img class="graf-image" data-image-id="1*1jpQ5HpQwY96J3-JxuhcYw.png" data-width="2606" data-height="1316" src="https://cdn-images-1.medium.com/max/1000/1*1jpQ5HpQwY96J3-JxuhcYw.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="1cc6" id="1cc6" class="graf graf--p graf-after--figure">If you try to solve it using DFS, you will surely come up with a solution, but there is a test case(s) that will exceed the allotted time limit on the LeetCode platform. That‚Äôs because of the problem described before as to why DFS takes so long (process 7 nodes as opposed to 3 in BFS) to reach the destination vertex.</p><p name="2555" id="2555" class="graf graf--p graf-after--p">Hope you got the main idea behind the two main graph traversals, and the difference between them when the application is shortest paths in an undirected unweighted graph.</p><p name="a3ec" id="a3ec" class="graf graf--p graf-after--p graf--trailing">Please recommend (‚ù§) this post if you think this may be useful for someone!</p></div></div></section>
</section>
</article></body></html>-->
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/04/16/How-we-fine-tuned-HAProxy-to-achieve-2-000-000-concurrent-SSL-connections-d017e61a4d27/">
        How we fine-tuned HAProxy to achieve 2,000,000 concurrent SSL connections
      </a>
    </h1>

    <span class="post-date">16 Apr 2017</span>
  
    
    <!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>How we fine-tuned HAProxy to achieve 2,000,000 concurrent SSL connections</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 100%;
        margin: auto;
      }
      section {
        width: 100%;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 100%;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">How we fine-tuned HAProxy to achieve 2,000,000 concurrent SSL connections</h1>
</header>
<section data-field="subtitle" class="p-summary">
If you look at the above screenshot closely, you‚Äôll find two important pieces of information:
</section>
<section data-field="body" class="e-content">
<section name="a192" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="6de9" id="6de9" class="graf graf--h3 graf--leading graf--title"></h3></div><div class="section-inner sectionLayout--outsetColumn"><figure name="b6df" id="b6df" class="graf graf--figure graf--layoutOutsetCenter graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1000px; max-height: 653px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 65.3%;"></div><img class="graf-image" data-image-id="1*H541cEeKLF2O_7wBoUOlPw.png" data-width="1704" data-height="1112" src="https://cdn-images-1.medium.com/max/1000/1*H541cEeKLF2O_7wBoUOlPw.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="82c9" id="82c9" class="graf graf--p graf-after--figure">If you look at the above screenshot closely, you‚Äôll find two important pieces of information:
    <br>
    <a href="/2017/04/16/How-we-fine-tuned-HAProxy-to-achieve-2-000-000-concurrent-SSL-connections-d017e61a4d27/">
         Read More...
    </a>
    <hr>
    <!--<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>How we fine-tuned HAProxy to achieve 2,000,000 concurrent SSL connections</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 100%;
        margin: auto;
      }
      section {
        width: 100%;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 100%;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">How we fine-tuned HAProxy to achieve 2,000,000 concurrent SSL connections</h1>
</header>
<section data-field="subtitle" class="p-summary">
If you look at the above screenshot closely, you‚Äôll find two important pieces of information:
</section>
<section data-field="body" class="e-content">
<section name="a192" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="6de9" id="6de9" class="graf graf--h3 graf--leading graf--title"></h3></div><div class="section-inner sectionLayout--outsetColumn"><figure name="b6df" id="b6df" class="graf graf--figure graf--layoutOutsetCenter graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1000px; max-height: 653px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 65.3%;"></div><img class="graf-image" data-image-id="1*H541cEeKLF2O_7wBoUOlPw.png" data-width="1704" data-height="1112" src="https://cdn-images-1.medium.com/max/1000/1*H541cEeKLF2O_7wBoUOlPw.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="82c9" id="82c9" class="graf graf--p graf-after--figure">If you look at the above screenshot closely, you‚Äôll find two important pieces of information:  <ol class="postList"><li name="e60e" id="e60e" class="graf graf--li graf-after--p">This machine has <strong class="markup--strong markup--li-strong">2.38 million TCP connections</strong> established, and</li><li name="d6d6" id="d6d6" class="graf graf--li graf-after--li">The amount of RAM being used is around <strong class="markup--strong markup--li-strong">48 Gigabytes</strong>.</li></ol><p name="f76c" id="f76c" class="graf graf--p graf-after--li">Pretty awesome right? What would be even more awesome is if someone provided the setup components, and the tunings required to achieve this kind of scale on a single HAProxy machine. Well, I‚Äôll do just that in this post¬†;)-->
    <!--<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>How we fine-tuned HAProxy to achieve 2,000,000 concurrent SSL connections</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 100%;
        margin: auto;
      }
      section {
        width: 100%;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 100%;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">How we fine-tuned HAProxy to achieve 2,000,000 concurrent SSL connections</h1>
</header>
<section data-field="subtitle" class="p-summary">
If you look at the above screenshot closely, you‚Äôll find two important pieces of information:
</section>
<section data-field="body" class="e-content">
<section name="a192" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="6de9" id="6de9" class="graf graf--h3 graf--leading graf--title"></h3></div><div class="section-inner sectionLayout--outsetColumn"><figure name="b6df" id="b6df" class="graf graf--figure graf--layoutOutsetCenter graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1000px; max-height: 653px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 65.3%;"></div><img class="graf-image" data-image-id="1*H541cEeKLF2O_7wBoUOlPw.png" data-width="1704" data-height="1112" src="https://cdn-images-1.medium.com/max/1000/1*H541cEeKLF2O_7wBoUOlPw.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="82c9" id="82c9" class="graf graf--p graf-after--figure">If you look at the above screenshot closely, you‚Äôll find two important pieces of information:</p><ol class="postList"><li name="e60e" id="e60e" class="graf graf--li graf-after--p">This machine has <strong class="markup--strong markup--li-strong">2.38 million TCP connections</strong> established, and</li><li name="d6d6" id="d6d6" class="graf graf--li graf-after--li">The amount of RAM being used is around <strong class="markup--strong markup--li-strong">48 Gigabytes</strong>.</li></ol><p name="f76c" id="f76c" class="graf graf--p graf-after--li">Pretty awesome right? What would be even more awesome is if someone provided the setup components, and the tunings required to achieve this kind of scale on a single HAProxy machine. Well, I‚Äôll do just that in this post¬†;)</p><p name="afd2" id="afd2" class="graf graf--p graf-after--p">This is the final part of the multipart series on load testing HAProxy. If you have time, I recommend you go and read the first two parts in the series first. These will help you get the hang of the kernel level tunings required on all the machines in this setup.</p><div name="c70c" id="c70c" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/@sachinmalhotra/load-testing-haproxy-part-1-f7d64500b75d" data-href="https://medium.com/@sachinmalhotra/load-testing-haproxy-part-1-f7d64500b75d" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/@sachinmalhotra/load-testing-haproxy-part-1-f7d64500b75d"><strong class="markup--strong markup--mixtapeEmbed-strong">Load Testing HAProxy (Part-1)</strong><br><em class="markup--em markup--mixtapeEmbed-em">Load Testing¬†? HAProxy¬†? If all this seems greek to you, don‚Äôt worry. I will provide inline links to read up on what‚Ä¶</em>medium.com</a><a href="https://medium.com/@sachinmalhotra/load-testing-haproxy-part-1-f7d64500b75d" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="bc71cf29ef089d2de5825936e454fd3a" data-thumbnail-img-id="1*4npSurj6b2n__CsxxnaUQw.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*4npSurj6b2n__CsxxnaUQw.png);"></a></div><div name="af15" id="af15" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://medium.com/@sachinmalhotra/load-testing-haproxy-part-2-4c8677780df6" data-href="https://medium.com/@sachinmalhotra/load-testing-haproxy-part-2-4c8677780df6" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/@sachinmalhotra/load-testing-haproxy-part-2-4c8677780df6"><strong class="markup--strong markup--mixtapeEmbed-strong">Load Testing HAProxy (Part 2)</strong><br><em class="markup--em markup--mixtapeEmbed-em">This is the second part in the 3 part series on performance testing of the famous TCP load balancer and reverse proxy‚Ä¶</em>medium.com</a><a href="https://medium.com/@sachinmalhotra/load-testing-haproxy-part-2-4c8677780df6" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="47a280510ad193d480b7bb21d23dd851" data-thumbnail-img-id="1*s2S16ZXbIxtsYIG87aOadg.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*s2S16ZXbIxtsYIG87aOadg.png);"></a></div><p name="4fb3" id="4fb3" class="graf graf--p graf-after--mixtapeEmbed">There are a lot of small components that helped us bring together the entire setup and achieve these numbers.</p><p name="a293" id="a293" class="graf graf--p graf-after--p">Before I tell you the final HAProxy configuration we used (if you‚Äôre super impatient you can scroll to the bottom) I want to build up to it by walking you through our thinking.</p><h3 name="1658" id="1658" class="graf graf--h3 graf-after--p">What we wanted to¬†test</h3><p name="f375" id="f375" class="graf graf--p graf-after--h3">The component we want to test was HAProxy version 1.6. We are using this in production right now on 4 core, 30 Gig machines. However, all the connectivity is non-SSL based.</p><p name="23e2" id="23e2" class="graf graf--p graf-after--p">We wanted to test two things out of this exercise:</p><ol class="postList"><li name="177f" id="177f" class="graf graf--li graf-after--p">The <strong class="markup--strong markup--li-strong">CPU percentage increase</strong> when we shift the entire load from non-SSL connections to SSL connections. The CPU usage should definitely increase, owing to the longer 5-way handshake and then the packet encryption.</li><li name="c019" id="c019" class="graf graf--li graf-after--li">Secondly, we wanted to test the limits of our current production setup in terms of number of requests and the max number of concurrent connections that can be supported before performance starts to degrade.</li></ol><p name="99f5" id="99f5" class="graf graf--p graf-after--li">We required the first part because of a major feature rollout that‚Äôs in full swing, which requires communication over SSL. We required the second part so that we could reduce the amount of hardware dedicated in production to HAProxy machines.</p><h3 name="ee55" id="ee55" class="graf graf--h3 graf-after--p">The Components Involved</h3><ul class="postList"><li name="55ae" id="55ae" class="graf graf--li graf-after--h3">Multiple client machines to stress the HAProxy.</li><li name="df41" id="df41" class="graf graf--li graf-after--li">Single HAProxy machine version 1.6 on various setups<br>* 4 core, 30 Gig<br>* 16 core, 30 Gig<br>* 16 core, 64 Gig</li><li name="bf32" id="bf32" class="graf graf--li graf-after--li">Backend servers that will help support all these concurrent connections.</li></ul><h3 name="fcb5" id="fcb5" class="graf graf--h3 graf-after--li">HTTP and¬†MQTT</h3><p name="1843" id="1843" class="graf graf--p graf-after--h3">If you‚Äôve gone through the <a href="https://medium.com/@sachinmalhotra/load-testing-haproxy-part-1-f7d64500b75d" data-href="https://medium.com/@sachinmalhotra/load-testing-haproxy-part-1-f7d64500b75d" class="markup--anchor markup--p-anchor" target="_blank">first article</a> in this series, you should know that our entire infrastructure is supported over two protocols:</p><ul class="postList"><li name="a21c" id="a21c" class="graf graf--li graf-after--p">HTTP and</li><li name="81e8" id="81e8" class="graf graf--li graf-after--li">MQTT.</li></ul><p name="aeec" id="aeec" class="graf graf--p graf-after--li">In our stack, we don‚Äôt use HTTP 2.0 and hence don‚Äôt have the functionality of persistent connections on HTTP. So on production the max number of TCP connections that we see is somewhere around (2 * 150k) on a single HAProxy machine (Inbound + Outbound). Although the number of concurrent connections is rather low, the number of requests per second is quite high.</p><p name="a86c" id="a86c" class="graf graf--p graf-after--p">On the other hand, MQTT is a different way altogether for communication. It offers great quality of service parameters and persistent connectivity as well. So bidirectional continuous communication can happen over a MQTT channel. As for HAProxy that supports MQTT (underlying TCP) connections, we see somewhere around 600‚Äì700k TCP connections at the peak time on a single machine.</p><p name="cdcb" id="cdcb" class="graf graf--p graf-after--p">We wanted to do a load test that will give us precise results for both HTTP and MQTT based connections.</p><p name="f4d6" id="f4d6" class="graf graf--p graf-after--p">There are a lot of tools out there that help us load test an HTTP server easily and a lot of these tools provide advanced functionalities like summarized results, converting text based results to graphs, etc. We could not, however, find any stress testing tool for MQTT. We do have a tool that we developed ourselves, but it was not stable enough to support this kind of load in the timeframe we had.</p><p name="ea08" id="ea08" class="graf graf--p graf-after--p">So we decided to go for load testing clients for HTTP and <em class="markup--em markup--p-em">simulating the MQTT setup using the same¬†;) </em>Interesting right?</p><p name="a2bf" id="a2bf" class="graf graf--p graf-after--p">Well read on.</p><h3 name="4955" id="4955" class="graf graf--h3 graf-after--p">The Initial¬†Setup</h3><p name="942e" id="942e" class="graf graf--p graf-after--h3">This is going to be a long post as I will be providing a lot of details that I think would be really helpful to someone doing similar load testing or fine tunings.</p><ul class="postList"><li name="ba5e" id="ba5e" class="graf graf--li graf-after--p">We took a 16 core 30 Gig machine for setting up HAProxy initially. We did not go with our current production setup because we thought the CPU hit because of SSL termination happening at the HAProxy end would be tremendous.</li><li name="4ca7" id="4ca7" class="graf graf--li graf-after--li">For the server end, we went with a simple NodeJs server that replies with <code class="markup--code markup--li-code">pong</code> on receiving a <code class="markup--code markup--li-code">ping</code> request.</li><li name="3182" id="3182" class="graf graf--li graf-after--li">As for the client, we ended up using <a href="https://httpd.apache.org/docs/2.4/programs/ab.html" data-href="https://httpd.apache.org/docs/2.4/programs/ab.html" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Apache Bench</a> initially. The reason we went with <code class="markup--code markup--li-code">ab</code> was because it was a very well known and stable tool for load testing HTTP end points and also because it provides beautiful summarized results that would help us a lot.</li></ul><p name="3927" id="3927" class="graf graf--p graf-after--li">The <code class="markup--code markup--p-code">ab</code> tool provides a lot of interesting parameters that we used for our load test like:</p><ul class="postList"><li name="ae20" id="ae20" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">- c, concurrency</code> Specifies the number of concurrent requests that would hit the server.</li><li name="0cce" id="0cce" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">-n, no. of requests</code> As the name suggests, specifies the total number of requests of the current load run.</li><li name="6c4e" id="6c4e" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">-p POST file</code> Contains the body of the POST request (if that is what you want to test.)</li></ul><p name="d7f0" id="d7f0" class="graf graf--p graf-after--li">If you look at these parameters closely, you will find that a lot of permutations are possible by tweaking all three. A sample ab request would look something like this</p><pre name="4faf" id="4faf" class="graf graf--pre graf-after--p">ab -S -p post_smaller.txt -T application/json -q -n 100000 -c 3000 http://test.haproxy.in:80/ping</pre><p name="3620" id="3620" class="graf graf--p graf-after--pre">A sample result of such a request looks something like this</p><figure name="f8a9" id="f8a9" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 803px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 114.7%;"></div><img class="graf-image" data-image-id="1*R40IjhjQTBDJS6xJ3oMHqg.png" data-width="1458" data-height="1672" src="https://cdn-images-1.medium.com/max/800/1*R40IjhjQTBDJS6xJ3oMHqg.png"></div></figure><p name="a84d" id="a84d" class="graf graf--p graf-after--figure">The numbers that we were interested in were</p><ul class="postList"><li name="524d" id="524d" class="graf graf--li graf-after--p">99% latency.</li><li name="fcd7" id="fcd7" class="graf graf--li graf-after--li">Time per request.</li><li name="9526" id="9526" class="graf graf--li graf-after--li">No. of failed requests.</li><li name="a5e0" id="a5e0" class="graf graf--li graf-after--li">Requests per second.</li></ul><p name="13eb" id="13eb" class="graf graf--p graf-after--li">The biggest problem of <code class="markup--code markup--p-code">ab</code> is that it does not provide a parameter to control the number of requests per second. We had to tweak the concurrency level to get our desired requests per second and this lead to a lot of trail and errors.</p><h3 name="f813" id="f813" class="graf graf--h3 graf-after--p">The Almighty¬†Graph</h3><p name="a1a7" id="a1a7" class="graf graf--p graf-after--h3">We could not randomly go about doing multiple load runs and keep getting results because that would not give us any meaningful information. We had to perform these tests in some specific way so as to get meaningful results out of it. So we followed this graph</p><figure name="5409" id="5409" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 650px; max-height: 500px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 76.9%;"></div><img class="graf-image" data-image-id="1*5NfdO-F4C_1qV4XMKJqNMw.png" data-width="650" data-height="500" src="https://cdn-images-1.medium.com/max/800/1*5NfdO-F4C_1qV4XMKJqNMw.png"></div></figure><p name="b20b" id="b20b" class="graf graf--p graf-after--figure">This graph states that up until a certain point, if we keep increasing the number of requests, the latency will remain almost the same. However, <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">beyond a certain tipping point</em></strong>, the latency will start to increase exponentially. It is this tipping point for a machine or for a setup that we intended to measure.</p><h3 name="61e2" id="61e2" class="graf graf--h3 graf-after--p">Ganglia</h3><p name="3d92" id="3d92" class="graf graf--p graf-after--h3">Before providing some test results, I would like to mention <a href="http://ganglia.sourceforge.net/" data-href="http://ganglia.sourceforge.net/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Ganglia</a>.</p><blockquote name="1b06" id="1b06" class="graf graf--blockquote graf-after--p">Ganglia is a scalable distributed monitoring system for high-performance computing systems such as clusters and Grids.</blockquote><p name="199c" id="199c" class="graf graf--p graf-after--blockquote">Look at the following screenshot of one of our machines to get an idea about what ganglia is and what sort of information it provides about the underlying machine.</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="e741" id="e741" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1000px; max-height: 397px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 39.7%;"></div><img class="graf-image" data-image-id="1*ABgypqN1-Cq2l4fRduxZYQ.png" data-width="2748" data-height="1090" src="https://cdn-images-1.medium.com/max/1000/1*ABgypqN1-Cq2l4fRduxZYQ.png"></div></figure><figure name="30eb" id="30eb" class="graf graf--figure graf--layoutOutsetCenter graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1000px; max-height: 436px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 43.6%;"></div><img class="graf-image" data-image-id="1*J3uFhy4njFCsISzsJsgYUg.png" data-width="2144" data-height="934" src="https://cdn-images-1.medium.com/max/1000/1*J3uFhy4njFCsISzsJsgYUg.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="98f8" id="98f8" class="graf graf--p graf-after--figure">Pretty interesting, eh?</p><p name="0699" id="0699" class="graf graf--p graf-after--p">Moving on, we constantly monitored ganglia for our HAProxy machine to monitor some important things.</p><ol class="postList"><li name="fb69" id="fb69" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">TCP established</code> This tells us the total number of tcp connections established on the system. NOTE: this is the sum of inbound as well as outbound connections.</li><li name="a32d" id="a32d" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">packets sent and received</code> We wanted to see the total number of tcp packets being sent and received by our HAProxy machine.</li><li name="fb58" id="fb58" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">bytes sent and received</code> This shows us the total data that we sent and received by the machine.</li><li name="b93e" id="b93e" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">memory</code> The amount of RAM being used over time.</li><li name="4c5d" id="4c5d" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">network</code> The network bandwidth consumption because of the packets being sent over the wire.</li></ol><p name="ea96" id="ea96" class="graf graf--p graf-after--li">Following are the known limits found via previous tests/numbers that we wanted to achieve via our load test.</p><blockquote name="3bcd" id="3bcd" class="graf graf--blockquote graf--hasDropCapModel graf-after--p">700k TCP established connections,<br>50k packets sent, 60k packets received,¬†<br>10‚Äì15MB bytes sent as well as received,¬†<br>14‚Äì15Gig memory at peak,¬†<br>7MB network.¬†<br><code class="markup--code markup--blockquote-code">ALL these values are on a per second basis</code></blockquote><h3 name="9e36" id="9e36" class="graf graf--h3 graf-after--blockquote">HAProxy Nbproc</h3><p name="3423" id="3423" class="graf graf--p graf-after--h3">Initially when we began load testing HAProxy, we found out that with SSL the CPU was being hit pretty early on in the process but the requests per second were very low. On investigating the <a href="http://www.tecmint.com/12-top-command-examples-in-linux/" data-href="http://www.tecmint.com/12-top-command-examples-in-linux/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">top</a> command, we found that HAProxy was using only 1 core. Whereas we had 15 more cores to spare.</p><p name="66b4" id="66b4" class="graf graf--p graf-after--p">Googling for about 10 minutes led us to find this interesting setting in HAProxy that lets HAProxy use multiple cores.</p><p name="903a" id="903a" class="graf graf--p graf-after--p">It‚Äôs called <code class="markup--code markup--p-code">nbproc</code> and to get a better hang of what it is and how to set it, check out this article:</p><p name="2528" id="2528" class="graf graf--p graf-after--p"><a href="http://blog.onefellow.com/post/82478335338/haproxy-mapping-process-to-cpu-core-for-maximum" data-href="http://blog.onefellow.com/post/82478335338/haproxy-mapping-process-to-cpu-core-for-maximum" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">http://blog.onefellow.com/post/82478335338/haproxy-mapping-process-to-cpu-core-for-maximum</a></p><p name="d8f5" id="d8f5" class="graf graf--p graf-after--p">Tuning this setting was the base of our load testing strategy moving forward. Because the ability to use multiple cores by HAProxy gave us the power to form multiple combinations for our load testing suite.</p><h3 name="2753" id="2753" class="graf graf--h3 graf-after--p">Load Testing with¬†AB</h3><p name="d63f" id="d63f" class="graf graf--p graf-after--h3">When we had started out with our load testing journey, we were not clear on the things we should be measuring and what we need to achieve.</p><p name="bc2e" id="bc2e" class="graf graf--p graf-after--p">Initially we had only one goal in mind and that was to find the tipping point only by variation of all the below mentioned parameters.</p><figure name="f7f8" id="f7f8" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 585px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 83.6%;"></div><img class="graf-image" data-image-id="1*_YxnDT0z5HOlY95pnbuFJw.png" data-width="1606" data-height="1342" src="https://cdn-images-1.medium.com/max/800/1*_YxnDT0z5HOlY95pnbuFJw.png"></div></figure><p name="426c" id="426c" class="graf graf--p graf-after--figure">I maintained a table of all the results for the various load tests that we gave. All in all I gave over 500 test runs to get to the ultimate result. As you can clearly see, there are a lot of moving parts to each and every test.</p><h4 name="a8e2" id="a8e2" class="graf graf--h4 graf-after--p">Single Client¬†issues</h4><p name="7ddb" id="7ddb" class="graf graf--p graf-after--h4">We started seeing that the client was becoming bottleneck as we kept on increasing our requests per second. Apache bench uses a single core and from the documentation it is evident that it does not provide any feature for using multiple cores.</p><p name="f88f" id="f88f" class="graf graf--p graf-after--p">To run multiple clients efficiently we found an interesting linux utility called <a href="http://www.shakthimaan.com/posts/2014/11/27/gnu-parallel/news.html" data-href="http://www.shakthimaan.com/posts/2014/11/27/gnu-parallel/news.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Parallel</a>. As the name suggests, it helps you run multiple commands in parallel and utilises multiple cores. Exactly what we wanted.</p><p name="b09c" id="b09c" class="graf graf--p graf-after--p">Have a look at a sample command that runs multiple clients using parallel.</p><pre name="6d83" id="6d83" class="graf graf--pre graf-after--p">cat hosts.txt |  parallel  &#39;ab  -S -p post_smaller.txt -T application/json -n 100000 -c 3000 {}&#39;</pre><pre name="cb12" id="cb12" class="graf graf--pre graf-after--pre">sachinm@ip-192-168-0-124:~$ cat hosts.txt<br>http://test.haproxy.in:80/ping<br>http://test.haproxy.in:80/ping<br>http://test.haproxy.in:80/ping</pre><p name="28e5" id="28e5" class="graf graf--p graf-after--pre">The above command would run 3 ab clients hitting the same URL. This helped us remove the client side bottleneck.</p><h4 name="a97a" id="a97a" class="graf graf--h4 graf-after--p">The Sleep and Times parameter</h4><p name="90e5" id="90e5" class="graf graf--p graf-after--h4">We talked about some parameters in ganglia that we wanted to track. Lets discuss them once by one.</p><ol class="postList"><li name="f1e5" id="f1e5" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">packets sent and received</code> This can be simulated by sending some data as a part of the post request. This would also help us generate some <code class="markup--code markup--li-code">network as well as bytes sent and received portions in ganglia</code></li><li name="4a31" id="4a31" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">tcp_established</code> This is something which took us a long, long time to actually simulate in our scenario. Imagine if a single ping request takes about a second, that would take us about 700k requests per second to reach our tcp_established milestone.¬†<br>Now this number might seem easier to achieve on production, but it was impossible to generate it in our scenario.</li></ol><p name="6aa7" id="6aa7" class="graf graf--p graf-after--li">What did we do you might ask? We introduced a sleep parameter in our POST call that specifies the number of milliseconds the server needs to sleep before sending out a response. This would simulate a long running request on production. So now say we have a sleep of about 20 minutes (Yep), that would take us around 583 requests per second to reach the 700k mark.</p><p name="f8bd" id="f8bd" class="graf graf--p graf-after--p">Additionally, we also introduced another parameter in our POST calls to the HAProxy and that was the <code class="markup--code markup--p-code">times</code> parameter. That specified number of times the server should write a response on the tcp connection before terminating it. This helped us simulated even more data transferred over the wire.</p><h4 name="9f9e" id="9f9e" class="graf graf--h4 graf-after--p">Issues with apache¬†bench</h4><p name="6020" id="6020" class="graf graf--p graf-after--h4">Although we found out a lot of results with apache bench, we also faced a lot of issues along the way. I won‚Äôt be mentioning all of them here as they are not important for this post as I‚Äôll be introducing another client shortly.</p><p name="6f5f" id="6f5f" class="graf graf--p graf-after--p">We were pretty content with the numbers we were getting out of apache bench, but at one point of time, generating the required tcp connections just became impossible. Somehow the apache bench was not handling the sleep parameter we had introduced, properly and was not scaling for us.</p><p name="7b9f" id="7b9f" class="graf graf--p graf-after--p">Although running multiple ab clients on a single machine was sorted out by using the parallel utility. Running this setup across multiple client machines was still a pain for us. I had not heard of the <a href="https://github.com/grondo/pdsh" data-href="https://github.com/grondo/pdsh" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">pdsh</a> utility by then and was practically stuck.</p><p name="b9a4" id="b9a4" class="graf graf--p graf-after--p">Also, we were not focussing on any timeouts as well. There are some default set of timeouts on the HAProxy, the ab client and the server and we had completely ignored these. We figured out a lot of things along the way and organized ourselves a lot on how to go about testing.</p><p name="3d2c" id="3d2c" class="graf graf--p graf-after--p">We used to talk about the tipping point graph but we deviated a lot from it as time went on. Meaningful results, however, could only be found by focusing on that.</p><p name="9dab" id="9dab" class="graf graf--p graf-after--p">With apache bench a point came where the number of TCP connections were not increasing. We had around 40‚Äì45 clients running on 5‚Äì6 different client boxes but were not able to achieve the scale we wanted. Theoretically, the number of TCP connections should have jumped as we went on increasing the sleep time, but it wasn‚Äôt working for us.</p><h3 name="0904" id="0904" class="graf graf--h3 graf-after--p">Enter Vegeta</h3></div><div class="section-inner sectionLayout--fullWidth"><figure name="da8b" id="da8b" class="graf graf--figure graf--layoutFillWidth graf-after--h3"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.3%;"></div><img class="graf-image" data-image-id="1*KGjslsE-jllJYpItVg84sA.png" data-width="1920" data-height="1080" src="https://cdn-images-1.medium.com/max/2000/1*KGjslsE-jllJYpItVg84sA.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="ee61" id="ee61" class="graf graf--p graf-after--figure">I was searching for some other load testing tools that might be more scalable and better functionality wise as compared to apache bench when I came across V<a href="https://github.com/tsenart/vegeta" data-href="https://github.com/tsenart/vegeta" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">egeta</a>.</p><p name="eafe" id="eafe" class="graf graf--p graf-after--p">From my personal experience, I have seen Vegeta to be extremely scalable and provides much better functionality as compared to apache bench. A single Vegeta client was able to produce the level of throughput equivalent to 15 apache bench clients in our load test.</p><p name="0cf6" id="0cf6" class="graf graf--p graf-after--p">Moving forward, I will be providing load test results that have been tested using Vegeta itself.</p><h3 name="c7fb" id="c7fb" class="graf graf--h3 graf-after--p">Load Testing with¬†Vegeta</h3><p name="b938" id="b938" class="graf graf--p graf-after--h3">First, have a look at the command that we used to run a single Vegeta client. Interestingly, the command to put load on the backend servers is called <code class="markup--code markup--p-code">attack</code>¬†:p</p><pre name="8713" id="8713" class="graf graf--pre graf-after--p">echo &quot;POST https://test.haproxy.in:443/ping&quot; | vegeta -cpus=32 attack -duration=10m  -header=&quot;sleep:30000&quot;  -body=post_smaller.txt -rate=2000 -workers=500  | tee reports.bin | vegeta report</pre><p name="0c02" id="0c02" class="graf graf--p graf-after--pre">Just love the parameters provided by Vegeta. Let‚Äôs have a look at some of these below.</p><ol class="postList"><li name="8a04" id="8a04" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">-cpus=32</code> Specifies the number of cores to be used by this client. We had to expand our client machines to 32core, 64Gig because of the amount of load to be generated. If you look closely above, the rate isn‚Äôt much. But it becomes difficult to sustain such a load when a lot of connections are in sleep state from the server end.</li><li name="fdda" id="fdda" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">-duration=10m</code> I guess this is self explanatory. If you don‚Äôt specify any duration, the test will run forever.</li><li name="5691" id="5691" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">-rate=2000</code> The number of requests per second.</li></ol><figure name="7ea2" id="7ea2" class="graf graf--figure graf-after--li"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 323px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 46.2%;"></div><img class="graf-image" data-image-id="1*8QYxI2VKQFtcsNk858eg0A.png" data-width="1542" data-height="712" src="https://cdn-images-1.medium.com/max/800/1*8QYxI2VKQFtcsNk858eg0A.png"></div></figure><p name="1660" id="1660" class="graf graf--p graf-after--figure">So as you can see above, we reached a hefty 32k requests per second on a mere 4 core machine. If you remember the tipping point graph, you will be able to notice it clearly enough above. So the tipping point in this case is 31.5k Non SSL requests.</p><p name="004d" id="004d" class="graf graf--p graf-after--p">Have a look at some more results from the load test.</p><figure name="31a8" id="31a8" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 271px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 38.7%;"></div><img class="graf-image" data-image-id="1*v3m7_R_c89id10wD8pxWrQ.png" data-width="1546" data-height="598" src="https://cdn-images-1.medium.com/max/800/1*v3m7_R_c89id10wD8pxWrQ.png"></div></figure><p name="54f1" id="54f1" class="graf graf--p graf-after--figure">16k SSL connections is also not bad at all. Please note that at this point in our load testing journey, we had to start from scratch because we had adopted a new client and it was giving us way better results than ab. So we had to do a lot of stuff again.</p><figure name="dd6b" id="dd6b" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 237px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 33.900000000000006%;"></div><img class="graf-image" data-image-id="1*aDkvgQvP3TNcIuUfEYa_fQ.png" data-width="1540" data-height="522" src="https://cdn-images-1.medium.com/max/800/1*aDkvgQvP3TNcIuUfEYa_fQ.png"></div></figure><p name="94ca" id="94ca" class="graf graf--p graf-after--figure">An increase in the number of cores led to an increase in the number of requests per second that the machine can take before the CPU limit is hit.</p><p name="71f9" id="71f9" class="graf graf--p graf-after--p">We found that there wasn‚Äôt a substantial increase in the number of requests per second if we increased the number of cores from 8 to 16. Also, if we finally decided to go with a 8 core machine in production, we would never allocate all of the cores to HAProxy or be it a any other process for that matter. So we decided to perform some tests with 6 cores as well to see if we had acceptable numbers.</p><figure name="be7d" id="be7d" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 171px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 24.4%;"></div><img class="graf-image" data-image-id="1*Ba_wms7xaxRi5EzOfPsvTQ.png" data-width="1542" data-height="376" src="https://cdn-images-1.medium.com/max/800/1*Ba_wms7xaxRi5EzOfPsvTQ.png"></div></figure><p name="6b6e" id="6b6e" class="graf graf--p graf-after--figure">Not bad.</p><h3 name="b9d0" id="b9d0" class="graf graf--h3 graf-after--p">Introducing the¬†sleep</h3><p name="934a" id="934a" class="graf graf--p graf-after--h3">We were pretty satisfied with our load test results till now. However, this did not simulate the real production scenario. That happened when we introduced a sleep time as well which was absent till now in our tests.</p><pre name="a7d0" id="a7d0" class="graf graf--pre graf-after--p">echo &quot;POST https://test.haproxy.in:443/ping&quot; | vegeta -cpus=32 attack -duration=10m  -header=&quot;sleep:1000&quot;  -body=post_smaller.txt-rate=2000 -workers=500  | tee reports.bin | vegeta report</pre><p name="ead8" id="ead8" class="graf graf--p graf-after--pre">So a sleep time of 1000 milliseconds would lead to server sleeping for <code class="markup--code markup--p-code">x</code> amount of time where <code class="markup--code markup--p-code">0&lt; x &lt; 1000</code> and is selected randomly. So on an average the above load test will give a latency of ‚â• 500ms</p><figure name="82c6" id="82c6" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 187px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 26.700000000000003%;"></div><img class="graf-image" data-image-id="1*BfBf2pUQDVc7D6dSWoxOmw.png" data-width="1550" data-height="414" src="https://cdn-images-1.medium.com/max/800/1*BfBf2pUQDVc7D6dSWoxOmw.png"></div></figure><p name="c09b" id="c09b" class="graf graf--p graf-after--figure">The numbers in the last cell represent</p><pre name="7bdd" id="7bdd" class="graf graf--pre graf-after--p">TCP established, Packets Rec, Packets Sent</pre><p name="8bd4" id="8bd4" class="graf graf--p graf-after--pre">respectively. As you can clearly see the max requests per second that the 6 core machine can support has decreased to 8k from 20k. Clearly, the sleep has its impact and that impact is the increase in the number of TCP connections established. This is however nowhere near to the 700k mark that we set out to achieve.</p><h3 name="2ed3" id="2ed3" class="graf graf--h3 graf-after--p">Milestone #1</h3><p name="d20a" id="d20a" class="graf graf--p graf-after--h3">How do we increase the number of TCP connections? Simple, we keep on increasing the sleep time and they should rise. We kept playing around with the sleep time and we stopped at the 60 seconds sleep time. That would mean an average latency of around 30 sec.</p><p name="7f00" id="7f00" class="graf graf--p graf-after--p">There is an interesting result parameter that Vegeta provides and that is % of requests successful. We saw that with the above sleep time, only 50% of the calls were succeeding. See the results below.</p><figure name="8b80" id="8b80" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 127px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 18.2%;"></div><img class="graf-image" data-image-id="1*-YAcVyKfw40Q84s3brTRdw.png" data-width="1542" data-height="280" src="https://cdn-images-1.medium.com/max/800/1*-YAcVyKfw40Q84s3brTRdw.png"></div></figure><p name="f721" id="f721" class="graf graf--p graf-after--figure">We achieved a whooping 400k TCP established connections with 8k requests per second and 60000 ms sleep time. The R in 60000R means Random.</p><p name="50cf" id="50cf" class="graf graf--p graf-after--p">The first real discovery we made was that there is a default call timeout in Vegeta which is of 30 seconds and that explained why 50% of our calls were failing. So we increased that to about 70s for our further tests and kept on varying it as and when the need arose.</p><figure name="fa37" id="fa37" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 377px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 53.900000000000006%;"></div><img class="graf-image" data-image-id="1*0RM6sCjY53Lr9gL-nMOWeQ.png" data-width="1544" data-height="832" src="https://cdn-images-1.medium.com/max/800/1*0RM6sCjY53Lr9gL-nMOWeQ.png"></div></figure><p name="d586" id="d586" class="graf graf--p graf-after--figure">We hit the 700k mark easily after tweaking the timeout value from the client end. The only problem with this was that these were not consistent. These were just peaks. So the system hit a peak of 600k or 700k but did not stay there for very long.</p><p name="6b6a" id="6b6a" class="graf graf--p graf-after--p">We however wanted something similar to this</p><figure name="42d0" id="42d0" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 304px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 43.4%;"></div><img class="graf-image" data-image-id="1*RJqRVlM6uspwaFytYVTUtw.png" data-width="1152" data-height="500" src="https://cdn-images-1.medium.com/max/800/1*RJqRVlM6uspwaFytYVTUtw.png"></div></figure><p name="348d" id="348d" class="graf graf--p graf-after--figure">This shows a stable state where 780k connections are maintained. If you look closely at the stats above, the number of requests per second are very high. On production however, we have much less number of requests (somewhere around 300) on a single HAProxy machine.</p><p name="a1df" id="a1df" class="graf graf--p graf-after--p">We were sure that if we drastically reduced the number of HAProxies we have on production (somewhere around 30, which means 30*300 ~ 9k connects per second) we will hit the machine limits w.r.t. the number of TCP connections first and not the CPU.</p><blockquote name="d256" id="d256" class="graf graf--blockquote graf-after--p">So we decided to achieve 900 requests per second and 30MB/s Network and 2.1Million TCP established connections. We agreed upon these numbers as these would be 3 times our production load on a single HAProxy.</blockquote><p name="58c3" id="58c3" class="graf graf--p graf-after--blockquote">Plus, till now we had settled on 6 cores being used by HAProxy. We wanted to test out 3 cores only because this is what would be easiest for us to roll out on our production machines (Our production machines, as mentioned before are 4 core 30 Gig. So for rolling out changes with <code class="markup--code markup--p-code">nbproc = 3</code> would be easiest for us.</p><pre name="5856" id="5856" class="graf graf--pre graf-after--p">REMEMBER the machine we had at this point in time was 16 core 30 Gig machine with 3 cores being allocated to HAProxy.</pre><h3 name="79bc" id="79bc" class="graf graf--h3 graf-after--pre">Milestone #2</h3><p name="9eaa" id="9eaa" class="graf graf--p graf-after--h3">Now that we had max limits on requests per second that different variations in machine configuration could support, we only had one task left as mentioned above.</p><p name="207d" id="207d" class="graf graf--p graf-after--p">Achieve 3X the production load which is</p><ul class="postList"><li name="6352" id="6352" class="graf graf--li graf-after--p">900 requests per second</li><li name="808b" id="808b" class="graf graf--li graf-after--li">2.1 million TCP established and</li><li name="318d" id="318d" class="graf graf--li graf-after--li">30 MB/s network.</li></ul><p name="54a4" id="54a4" class="graf graf--p graf-after--li">We got stuck yet again as the TCP established were taking a hard hit at 220k. No matter what the number of client machines or what the sleep time was, number of TCP connections seemed to have stuck there.</p><p name="df14" id="df14" class="graf graf--p graf-after--p">Let‚Äôs look at some calculations. 220k TCP established connections and 900 requests per second = 110,000 / 900 ~= 120 seconds¬†.I took 110k because 220k connections include both incoming and outgoing. So it‚Äôs two way.</p><p name="9189" id="9189" class="graf graf--p graf-after--p">Our doubt about 2 minutes being a limit somewhere in the system was verified when we introduced logs on the HAProxy side. We could see 120000 ms as total time for a lot of connections in the logs.</p><pre name="216b" id="216b" class="graf graf--pre graf-after--p">Mar 23 13:24:24 localhost haproxy[53750]: 172.168.0.232:48380 [23/Mar/2017:13:22:22.686] api~ api-backend/http31 39/0/2062/-1/122101 -1 0 - - SD-- 1714/1714/1678/35/0 0/0 {0,&quot;&quot;,&quot;&quot;} &quot;POST /ping HTTP/1.1&quot;</pre><pre name="764b" id="764b" class="graf graf--pre graf-after--pre">122101 is the timeout value. See HAProxy documentation on meanings of all these values. </pre><p name="0302" id="0302" class="graf graf--p graf-after--pre">On investigating further we found out that NodeJs has a default request timeout of 2 minutes. Voila¬†!</p><figure name="1b21" id="1b21" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 912px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 130.29999999999998%;"></div><img class="graf-image" data-image-id="1*GnRdySeu4J-6UnkHGOiuuA.png" data-width="1228" data-height="1600" src="https://cdn-images-1.medium.com/max/800/1*GnRdySeu4J-6UnkHGOiuuA.png"></div></figure><div name="7f4a" id="7f4a" class="graf graf--mixtapeEmbed graf-after--figure"><a href="http://stackoverflow.com/questions/23925284/how-to-modify-the-nodejs-request-default-timeout-time" data-href="http://stackoverflow.com/questions/23925284/how-to-modify-the-nodejs-request-default-timeout-time" class="markup--anchor markup--mixtapeEmbed-anchor" title="http://stackoverflow.com/questions/23925284/how-to-modify-the-nodejs-request-default-timeout-time"><strong class="markup--strong markup--mixtapeEmbed-strong">how to modify the nodejs request default timeout time?</strong><br><em class="markup--em markup--mixtapeEmbed-em">I was using nodejs request, the default timeout of nodejs http is 120000 ms, but it is not enough for me, while my‚Ä¶</em>stackoverflow.com</a><a href="http://stackoverflow.com/questions/23925284/how-to-modify-the-nodejs-request-default-timeout-time" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="69a6ce6ceca32709e65c1298a96eba04" data-thumbnail-img-id="0*I9pljOqQJDl9Hfxv." style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*I9pljOqQJDl9Hfxv.);"></a></div><div name="f347" id="f347" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://nodejs.org/api/http.html#http_server_settimeout_msecs_callback" data-href="https://nodejs.org/api/http.html#http_server_settimeout_msecs_callback" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://nodejs.org/api/http.html#http_server_settimeout_msecs_callback"><strong class="markup--strong markup--mixtapeEmbed-strong">HTTP | Node.js v7.8.0 Documentation</strong><br><em class="markup--em markup--mixtapeEmbed-em">The HTTP interfaces in Node.js are designed to support many features of the protocol which have been traditionally‚Ä¶</em>nodejs.org</a><a href="https://nodejs.org/api/http.html#http_server_settimeout_msecs_callback" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="569a99a63445102def730e4cde08785e"></a></div><p name="4321" id="4321" class="graf graf--p graf-after--mixtapeEmbed">But our happiness was apparently short lived. At 1.3 million, the HAProxy connections suddenly dropped to 0 and started increasing again. We soon checked the <a href="http://www.linfo.org/dmesg.html" data-href="http://www.linfo.org/dmesg.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">dmesg</a> command that provided us some useful kernel level information for our HAProxy process.</p><p name="8c5e" id="8c5e" class="graf graf--p graf-after--p">Basically, the HAProxy process had gone out of memory. So we decided to increase the machine RAM and we shifted to 16 core 64 Gig machine with <code class="markup--code markup--p-code">nbproc = 3</code> and because of this change we were able to reach 2.4 million connections.</p><h3 name="8d9e" id="8d9e" class="graf graf--h3 graf-after--p">Backend Code</h3><p name="c225" id="c225" class="graf graf--p graf-after--h3">Following is the backend server code that was being used. We had also used statsd in the server code to get consolidated data on requests per second that were being received by the client.</p><pre name="ae99" id="ae99" class="graf graf--pre graf-after--p">var http = require(&#39;http&#39;);<br>var createStatsd = require(&#39;uber-statsd-client&#39;);<br>qs = require(&#39;querystring&#39;);</pre><pre name="f6eb" id="f6eb" class="graf graf--pre graf-after--pre">var sdc = createStatsd({<br>host: &#39;172.168.0.134&#39;,<br>port: 8125<br>});</pre><pre name="9a27" id="9a27" class="graf graf--pre graf-after--pre">var argv = process.argv;<br>var port = argv[2];</pre><pre name="1159" id="1159" class="graf graf--pre graf-after--pre">function randomIntInc (low, high)<br>{<br>    return Math.floor(Math.random() * (high - low + 1) + low);<br>}</pre><pre name="3677" id="3677" class="graf graf--pre graf-after--pre">function sendResponse(res,times, old_sleep)<br>{<br>    res.write(&#39;pong&#39;);<br>    if(times==0)<br>    {<br>        res.end();<br>    }<br>    else<br>    { <br>        sleep = randomIntInc(0, old_sleep+1);<br>        setTimeout(sendResponse, sleep, res,times-1, old_sleep);<br>    }<br>}</pre><pre name="6125" id="6125" class="graf graf--pre graf-after--pre">var server = http.createServer(function(req, res)<br>{<br>   headers = req.headers;<br>   old_sleep = parseInt(headers[&quot;sleep&quot;]);<br>   times = headers[&quot;times&quot;] || 0;<br>   sleep = randomIntInc(0, old_sleep+1);<br>   console.log(sleep);<br>   sdc.increment(&quot;ssl.server.http&quot;);<br>   res.writeHead(200);<br>   setTimeout(sendResponse, sleep, res, times, old_sleep)</pre><pre name="8e8a" id="8e8a" class="graf graf--pre graf-after--pre">});</pre><pre name="f149" id="f149" class="graf graf--pre graf-after--pre">server.timeout = 3600000;<br>server.listen(port);</pre><p name="0181" id="0181" class="graf graf--p graf-after--pre">We also had a small script to run multiple backend servers. We had 8 machines with 10 backend servers EACH (yeah¬†!). We literally took the idea of clients and backend servers being infinite for the load test, seriously.</p><pre name="500e" id="500e" class="graf graf--pre graf-after--p">counter=0<br>while [ $counter -le 9 ]<br>do<br>   port=$((8282+$counter))<br>   nodejs /opt/local/share/test-tools/HikeCLI/nodeclient/httpserver.js $port &amp;<br>   echo &quot;Server created on port &quot;  $port</pre><pre name="a17c" id="a17c" class="graf graf--pre graf-after--pre">   ((counter++))<br>done</pre><pre name="bbc4" id="bbc4" class="graf graf--pre graf-after--pre">echo &quot;Created all servers&quot;</pre><h3 name="3b40" id="3b40" class="graf graf--h3 graf-after--pre">Client Code</h3><p name="219b" id="219b" class="graf graf--p graf-after--h3">As for the client, there was a limitation of 63k TCP connections per IP. If you are not sure about this concept, please refer my <a href="https://medium.com/@sachinmalhotra/load-testing-haproxy-part-2-4c8677780df6" data-href="https://medium.com/@sachinmalhotra/load-testing-haproxy-part-2-4c8677780df6" class="markup--anchor markup--p-anchor" target="_blank">previous article</a> in this series.</p><p name="7eb5" id="7eb5" class="graf graf--p graf-after--p">So in order to achieve 2.4 million connections (two sided which is 1.2 million from the client machines), we needed somewhere around 20 machines. Its a pain really to run the Vegeta command on all 20 machines one by one and even of you found a way to do that using something like <a href="https://github.com/brockgr/csshx" data-href="https://github.com/brockgr/csshx" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">csshx</a>, you still would need something to combine all the results from all the Vegeta clients.</p><p name="7e51" id="7e51" class="graf graf--p graf-after--p">Check out the script below.</p><pre name="12fe" id="12fe" class="graf graf--pre graf-after--p">result_file=$1</pre><pre name="3004" id="3004" class="graf graf--pre graf-after--pre">declare -a machines=(&quot;172.168.0.138&quot; &quot;172.168.0.141&quot; &quot;172.168.0.142&quot; &quot;172.168.0.18&quot; &quot;172.168.0.5&quot; &quot;172.168.0.122&quot; &quot;172.168.0.123&quot; &quot;172.168.0.124&quot; &quot;172.168.0.232&quot; &quot; 172.168.0.244&quot; &quot;172.168.0.170&quot; &quot;172.168.0.179&quot; &quot;172.168.0.59&quot; &quot;172.168.0.68&quot; &quot;172.168.0.137&quot; &quot;172.168.0.155&quot; &quot;172.168.0.154&quot; &quot;172.168.0.45&quot; &quot;172.168.0.136&quot; &quot;172.168.0.143&quot;)</pre><pre name="aa85" id="aa85" class="graf graf--pre graf-after--pre">bins=&quot;&quot;<br>commas=&quot;&quot;</pre><pre name="e6ee" id="e6ee" class="graf graf--pre graf-after--pre">for i in &quot;${machines[@]}&quot;; do bins=$bins&quot;,&quot;$i&quot;.bin&quot;; commas=$commas&quot;,&quot;$i;  done;</pre><pre name="96e3" id="96e3" class="graf graf--pre graf-after--pre">bins=${bins:1}<br>commas=${commas:1}</pre><pre name="6e77" id="6e77" class="graf graf--pre graf-after--pre">pdsh -b -w &quot;$commas&quot; &#39;echo &quot;POST http://test.haproxy.in:80/ping&quot; | /home/sachinm/.linuxbrew/bin/vegeta -cpus=32 attack -connections=1000000 -header=&quot;sleep:20&quot; -header=&quot;times:2&quot; -body=post_smaller.txt -timeout=2h -rate=3000 -workers=500 &gt; &#39; $result_file</pre><pre name="ccf9" id="ccf9" class="graf graf--pre graf-after--pre">for i in &quot;${machines[@]}&quot;; do  scp sachinm@$i:/home/sachinm/$result_file $i.bin ; done;</pre><pre name="f5fb" id="f5fb" class="graf graf--pre graf-after--pre">vegeta report -inputs=&quot;$bins&quot;</pre><p name="6ece" id="6ece" class="graf graf--p graf-after--pre">Apparently, Vegeta provides information on this utility called <a href="https://github.com/grondo/pdsh" data-href="https://github.com/grondo/pdsh" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">pdsh</a> that lets you run a command concurrently on multiple machines remotely¬†. Additionally, the Vegeta allows us to combine multiple results into one and that‚Äôs really all we wanted.</p><h3 name="5d37" id="5d37" class="graf graf--h3 graf-after--p">HAProxy Configuration</h3><p name="0f79" id="0f79" class="graf graf--p graf-after--h3">This is probably what you came here looking for, below is the HAProxy config that we used in our load test runs. The most important part being that of the <code class="markup--code markup--p-code">nbproc</code> setting and the <code class="markup--code markup--p-code">maxconn</code> setting. The maxconn setting allows us to provide the maximum number of TCP connections that the HAProxy can support overall (one way).</p><p name="7d0b" id="7d0b" class="graf graf--p graf-after--p">Changes to <code class="markup--code markup--p-code">maxconn</code> setting leads to increase in HAProxy process‚Äô ulimit. Take a look below</p><figure name="ffc2" id="ffc2" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 304px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 43.5%;"></div><img class="graf-image" data-image-id="1*At2DHNGCMm9hUPbKRvtX4g.png" data-width="1568" data-height="682" src="https://cdn-images-1.medium.com/max/800/1*At2DHNGCMm9hUPbKRvtX4g.png"></div></figure><p name="44ca" id="44ca" class="graf graf--p graf-after--figure">The max open files has increased to 4 million because of the max connections for HAProxy being set at 2 million. Neat¬†!</p><p name="24da" id="24da" class="graf graf--p graf-after--p">Check the article below for a whole lot of HAProxy optimisations that you can and should do to achieve the kind of stats we achieved.</p><div name="eba5" id="eba5" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://www.linangran.com/?p=547" data-href="https://www.linangran.com/?p=547" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://www.linangran.com/?p=547"><strong class="markup--strong markup--mixtapeEmbed-strong">Use HAProxy to load balance 300k concurrent tcp socket connections: Port Exhaustion, Keep-alive and‚Ä¶</strong><br><em class="markup--em markup--mixtapeEmbed-em">I&#39;m trying to build up a push system recently. To increase the scalability of the system, the best practice is to make‚Ä¶</em>www.linangran.com</a><a href="https://www.linangran.com/?p=547" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="8d00329a02e93224a861ca93e4c60a64" data-thumbnail-img-id="0*NoW97lRlDGmHnsPJ." style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*NoW97lRlDGmHnsPJ.);"></a></div><figure name="55a9" id="55a9" class="graf graf--figure graf-after--mixtapeEmbed"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 687px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 98.1%;"></div><img class="graf-image" data-image-id="1*sd0hWfAkh-iwzo4AKrCSuA.png" data-width="1250" data-height="1226" src="https://cdn-images-1.medium.com/max/800/1*sd0hWfAkh-iwzo4AKrCSuA.png"></div></figure><figure name="90a5" id="90a5" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 737px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 105.3%;"></div><img class="graf-image" data-image-id="1*pGyKr5KepjpzKIy--QcDPg.png" data-width="1600" data-height="1684" src="https://cdn-images-1.medium.com/max/800/1*pGyKr5KepjpzKIy--QcDPg.png"></div></figure><p name="2fcc" id="2fcc" class="graf graf--p graf-after--figure">The http30 goes on to http83¬†:p</p><p name="f9f5" id="f9f5" class="graf graf--p graf-after--p">That‚Äôs all for now folks. If you‚Äôve it so far, I‚Äôm truly amazed¬†:)</p><p name="11f1" id="11f1" class="graf graf--p graf-after--p">A special shout out to <a href="https://medium.com/u/7a4e80f5af06" data-href="https://medium.com/u/7a4e80f5af06" data-anchor-type="2" data-user-id="7a4e80f5af06" data-action-value="7a4e80f5af06" data-action="show-user-card" data-action-type="hover" class="markup--user markup--p-user" target="_blank">Dheeraj Kumar Sidana</a> who helped us all the way through this and without whose help we would not have been able to reach any meaningful results.¬†:)</p><p name="a75b" id="a75b" class="graf graf--p graf-after--p graf--trailing">Do let me know how this blog post helped you. Also, please recommend (‚ù§) and spread the love as much as possible for this post if you think this might be useful for someone.</p></div></div></section>
</section>
</article></body></html>-->
  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page3">Older</a>
  
  
    
      <a class="pagination-item newer" href="/">Newer</a>
    
  
</div>

    </div>

  </body>
</html>

---
layout: post
title: "How my mentor saved me from breaking 50 production servers"
comments: True
---

<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>How my mentor saved me from breaking 50 production servers</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 100%;
        margin: auto;
      }
      section {
        width: 100%;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 100%;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">How my mentor saved me from breaking 50 production servers</h1>
</header>
<section data-field="subtitle" class="p-summary">
Hundreds of production servers being blasted with requests from millions of users on a per second basis. A slight delay in serving a…
</section>
<section data-field="body" class="e-content">
<section name="4907" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--fullWidth"><figure name="1a1f" id="1a1f" class="graf graf--figure graf--layoutFillWidth graf--leading"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 67.10000000000001%;"></div><img class="graf-image" data-image-id="1*WGDDXDYWMqgCYSoZorNmiA.jpeg" data-width="2235" data-height="1500" src="https://cdn-images-1.medium.com/max/2000/1*WGDDXDYWMqgCYSoZorNmiA.jpeg"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><h3 name="b1d6" id="b1d6" class="graf graf--h3 graf-after--figure graf--title"></h3><p name="ecd5" id="ecd5" class="graf graf--p graf-after--h3">Hundreds of production servers being blasted with requests from millions of users on a per second basis. A slight delay in serving a request may lead the customer to uninstall the application. A sluggish or an unresponsive service may cause things to go haywire. And you are responsible for making a small code change in such a system. What do you do ? How do you go about it ?</p><p name="ffc2" id="ffc2" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">TLDR; </strong>This article is my retrospective on a potential screw up on our production system due to a bad code I wrote.</p><p name="c0b2" id="c0b2" class="graf graf--p graf-after--p">I work as a Backend Developer at a startup where we deal with features and bug fixes affecting millions of people on a daily basis. A small fracture in the code and it doesn’t take time before shit hits the fan.</p><p name="2b85" id="2b85" class="graf graf--p graf-after--p">We are a messaging based platform and large part of the messaging volume are Stickers. Something like this —</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="529e" id="529e" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1000px; max-height: 413px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 41.3%;"></div><img class="graf-image" data-image-id="1*Z1VabAJZ9dguiXQjXyIiPQ.png" data-width="1600" data-height="661" src="https://cdn-images-1.medium.com/max/1000/1*Z1VabAJZ9dguiXQjXyIiPQ.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="c240" id="c240" class="graf graf--p graf-after--figure">We have a dedicated team for curating content for stickers and they recently came up with the idea of animated stickers. Customers got bored of the static stickers and putting some animation in them could prove useful for us.</p><p name="2aee" id="2aee" class="graf graf--p graf-after--p">From a technical standpoint on the server end, a small requirement came up. We needed to put in some hacks in place to maintain backward compatibility with older clients.</p><blockquote name="4f88" id="4f88" class="graf graf--pullquote graf-after--p">Whenever a new client i.e. a supported build for the animated stickers sends a packet to an older client i.e. the unsupported build, we should send a customised message to the older client telling them to upgrade to the newer build. We cannot directly send an animated sticker as the older client won’t understand it and the application might crash.</blockquote><p name="4fdf" id="4fdf" class="graf graf--p graf-after--pullquote">Well this looks pretty simple right ? Just a couple of version checks on the server side and you’re good to go. However, the client one upped this by adding that the intercept message should be customised and should be different for every animated sticker<strong class="markup--strong markup--p-strong">. </strong>This was also not much of an effort. We just had to save the intercept messages in our existing sticker database (which is Mongo right now) and put a cache on top of it to prevent redundant calls to Mongo and we were good to go.</p><p name="6e7c" id="6e7c" class="graf graf--p graf-after--p">The problem was with identification of an animated sticker whenever one came in our server flow. The simplest way would have been where the client tells us if it’s a static sticker or an animated sticker. But this was not always possible — we were told — because of some bug on an older version of the application.</p><p name="d465" id="d465" class="graf graf--p graf-after--p">Every sticker packet has a stickerId associated with it. It is a unique Id generated by the sticker team while storing sticker content in the database. An animated sticker packet (JSON packet) would look something like this</p><pre name="b6f1" id="b6f1" class="graf graf--pre graf-after--p">{<br>     &quot;t&quot;: &quot;st&quot;,</pre><pre name="981a" id="981a" class="graf graf--pre graf-after--pre">     &quot;md&quot;: <br>         {</pre><pre name="e59a" id="e59a" class="graf graf--pre graf-after--pre">              &quot;is_anim&quot;: 1</pre><pre name="90d2" id="90d2" class="graf graf--pre graf-after--pre">         },</pre><pre name="6e41" id="6e41" class="graf graf--pre graf-after--pre">     &quot;stkId&quot;: &quot;loveydovey123&quot;<br>}</pre><p name="fccf" id="fccf" class="graf graf--p graf-after--pre">The <strong class="markup--strong markup--p-strong">is_anim<em class="markup--em markup--p-em"> </em></strong>field may or may not be present always. So we needed another way of differentiating animated from a static sticker.</p><p name="6b49" id="6b49" class="graf graf--p graf-after--p">Without much deliberation I came up with a solution. We store the sticker data in MongoDb and we also keep a field in the document for each sticker indicating if it is an enhanced sticker.</p><p name="8169" id="8169" class="graf graf--p graf-after--p">I wrote the code in such a way that for every given sticker (for which <strong class="markup--strong markup--p-strong">is_anim<em class="markup--em markup--p-em"> </em></strong>is missing), the code would hit an in memory cache — which would keep the intercept message (if any) as described before and would also tell us if the given sticker packet is an animated one for a period of 2 hours. In case of a cache miss the code will hit the persistent storage i.e. Mongo in this case and populate the in memory cache as well. Lets look at the pseudo code</p><pre name="8105" id="8105" class="graf graf--pre graf-after--p">public boolean isAnimatedSticker(String stickerId)<br>{     <br>     boolean isAnimated = CacheManager.get(stickerId);</pre><pre name="dcc7" id="dcc7" class="graf graf--pre graf-after--pre">     if(isAnimated != null &amp;&amp; isAnimated == true) <br>        return true;<br> <br>     if(isAnimated == null)<br>        return populateCacheFromDbAndReturnData(stickerId);</pre><pre name="c214" id="c214" class="graf graf--pre graf-after--pre">     return false;</pre><pre name="0b67" id="0b67" class="graf graf--pre graf-after--pre">}</pre><p name="0836" id="0836" class="graf graf--p graf-after--pre">Simple piece of code right ? Checks the cache to see if the sticker is enhanced, if nothing is found in the cache it hits the database and populates the cache and also returns the desired result. All this worked right off the bat and was tested thoroughly on our staging and dev environments.</p><p name="7cd9" id="7cd9" class="graf graf--p graf-after--p">There was a lot of pressure from the product manager for animated stickers as their release was due in a couple of days (release of a new build in the market). So we were in a hurry to get the change set deployed on production.</p><p name="9253" id="9253" class="graf graf--p graf-after--p">My mentor and some other seniors in the team were vey careful in taking any changes to production at that time owing to a major service outage already affecting us.</p><p name="4cf2" id="4cf2" class="graf graf--p graf-after--p">While reviewing the code, my mentor raised a crucial question I had failed to address. He asked me why, I was querying Mongo and how many times will I do it. I told him when and why I would be doing it. Then he asked me</p><blockquote name="8fc1" id="8fc1" class="graf graf--pullquote graf--startsWithDoubleQuote graf-after--p"><strong class="markup--strong markup--pullquote-strong">“Will I hit Mongo for every unique sticker packet once on every production machine to check if it is animated ?”</strong></blockquote><p name="3ddc" id="3ddc" class="graf graf--p graf-after--pullquote">I said “<em class="markup--em markup--p-em">Only for the ones for which is_anim field is missing. Basically for every static sticker and some animated stickers</em>” ! He said this will <strong class="markup--strong markup--p-strong">definitely</strong> <strong class="markup--strong markup--p-strong">break production</strong>. I was like</p><figure name="2e44" id="2e44" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 512px; max-height: 351px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 68.60000000000001%;"></div><img class="graf-image" data-image-id="1*kyWSPddrwLomm1FmVDdoQg.jpeg" data-width="512" data-height="351" src="https://cdn-images-1.medium.com/max/800/1*kyWSPddrwLomm1FmVDdoQg.jpeg"></div></figure><p name="03c3" id="03c3" class="graf graf--p graf-after--figure">He didn’t say it that calmly though. He was pissed at me for coming up with a stupid design. We have about 50 production servers and every server will have its own in memory cache. Out of the 24,000 messages per second in peak time, we have about 8k messages for stickers. <strong class="markup--strong markup--p-strong">Out of these 8000 messages, 3000 are unique stickers</strong> — We have about 12,000 unique stickers on the app today and stickers is one of our most used and loved feature.</p><p name="a862" id="a862" class="graf graf--p graf-after--p">That means 3k Mongo calls per production server which when escalated to 5o servers would mean around 150k calls on Mongo in a very short span of time. This will definitely bring down the stickers Mongo server as it is not very well scaled right now. It is tuned to serve around 1–2k calls at max.</p><p name="b420" id="b420" class="graf graf--p graf-after--p">This scenario would have taken place at the time of deploying my code on production. Although we have a 4 minute gap between server restarts but the design still sucked and my manager wasn’t going to take any chances with it. This was alarming also because the change set was written in a manner where it would affect the main messaging flow.</p><p name="10ec" id="10ec" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">It should have been written in an asynchronous manner in the first place</strong> where any outage in the animated stickers code would not affect other services in the infrastructure.</p><p name="43ba" id="43ba" class="graf graf--p graf-after--p">This was supposed to be a simple change to be done under the radar but I ended up being ridiculed for doing such a poor effort. What I learnt from this small (major ?) incident is that before diving into the task assigned and becoming coding ninjas right away, you should adhere to certain guidelines.</p><h3 name="a7e7" id="a7e7" class="graf graf--h3 graf-after--p">Think before you Code</h3><p name="7610" id="7610" class="graf graf--p graf-after--h3">Never go off writing code based on the first solution that comes to your mind. Always write down a basic pseudo code first and then consider all possibilities where things could possibly go wrong and break the system. This should be done irrespective of how large or small the change set is. Even for a hot fix !</p><figure name="4ccd" id="4ccd" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 550px; max-height: 832px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 151.29999999999998%;"></div><img class="graf-image" data-image-id="1*RNT-8qt-DXLJWDva8t7C3w.jpeg" data-width="550" data-height="832" src="https://cdn-images-1.medium.com/max/800/1*RNT-8qt-DXLJWDva8t7C3w.jpeg"></div></figure><h3 name="46f3" id="46f3" class="graf graf--h3 graf-after--figure">Some Key parameters to Ponder</h3><p name="e865" id="e865" class="graf graf--p graf-after--h3">Code is anything but a few lines of the language syntax. Before finalising any solution for the problem at hand, do consider the following parameters</p><ul class="postList"><li name="7a9e" id="7a9e" class="graf graf--li graf-after--p">Code should be clean and easy to understand.</li><li name="5d6f" id="5d6f" class="graf graf--li graf-after--li">Should be Unit Testable.</li><li name="1007" id="1007" class="graf graf--li graf-after--li">If your code is interacting with external services or databases, make sure to not overwhelm them. You should have some sort of caching or rate limiting in place.</li><li name="5836" id="5836" class="graf graf--li graf-after--li">Before writing any code from scratch, always try and find in the current system if something has already been implemented.</li></ul><h3 name="19a8" id="19a8" class="graf graf--h3 graf-after--li">Load Testing is a Must</h3><p name="3a7a" id="3a7a" class="graf graf--p graf-after--h3">Most of the times functional testing is not enough. Like in this case, if some sort of load testing had been done, this problem would not have surfaced right before deployment. So there should always be certain automated test cases — or as most people call it a <strong class="markup--strong markup--p-strong">Regression Suite — </strong>ready to run on your change set along with some sort of fabricated load to verify if nothing breaks.</p><h3 name="9ea7" id="9ea7" class="graf graf--h3 graf-after--p">Say NO to Hacks</h3><p name="8c6e" id="8c6e" class="graf graf--p graf-after--h3">The server guys get a lot of requests from the client to put in hacks just because of some buggy builds that went out. Sometimes it is easy to put in a hack but over a period of time things get messy. The code quickly changes from an elegantly structured piece of software to garbled shit no one can understand.</p><p name="4552" id="4552" class="graf graf--p graf-after--p">Start saying NO to the client guys. Only accommodate changes if they can be done in time, with proper functional and load testing and thorough code review.</p><h3 name="8a24" id="8a24" class="graf graf--h3 graf-after--p">Go the Async Way</h3><p name="9382" id="9382" class="graf graf--p graf-after--h3">I’m sure most of the audience here would be familiar with the concept of Micro services. A small component of code that can be built, tested and deployed independently of the main code. That is how stuff should be written in my opinion.</p><p name="ba3c" id="ba3c" class="graf graf--p graf-after--p">You can’t go on modifying the main code flow because a small mistake on your part could cause a major outage. So try and write code that is asynchronous and thus works independently off the main flow.</p><p name="bfbd" id="bfbd" class="graf graf--p graf-after--p">Ofcourse, don’t go on making every feature a microservice in itself.</p><h3 name="98e3" id="98e3" class="graf graf--h3 graf-after--p">UPDATE</h3><p name="6003" id="6003" class="graf graf--p graf-after--h3">I did not mention the final solution which we came at after discussions because that in itself was another hack. There is another component of every sticker called the<strong class="markup--strong markup--p-strong"> category Id</strong>.</p><p name="18cc" id="18cc" class="graf graf--p graf-after--p">We have different packs of stickers and each pack has a unique categoryId and in it every sticker in itself has a stickerId. We were told that only 3 packs of animated stickers will be released on production and so we decided on supporting just those three (in cases where client does not provide any info on sticker being animated in the JSON itself). So we hard coded those 3 category IDs , something like this</p><pre name="abe1" id="abe1" class="graf graf--pre graf-after--p">if(packet.getMetdata.contains(anim_field) || categoryId is one of list(a,b,c))<br>{ <br> <br>       isAnimated = True;</pre><pre name="263b" id="263b" class="graf graf--pre graf-after--pre">} </pre><p name="f101" id="f101" class="graf graf--p graf-after--pre graf--trailing">This again is not an elegant solution but there isn’t one for such problems I guess. There has to be some sort of a common ground between client and the server.</p></div></div></section>
</section>
</article></body></html>
